{% extends "base.html" %}

{% block title %}Edit System - {{ system.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-pencil-square"></i> Edit System</h1>
                <p class="lead">Update system configuration for "{{ system.name }}"</p>
            </div>
            <a href="{{ url_for('system_detail', system_id=system.id) }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to System
            </a>
        </div>
    </div>
</div>

<div class="row justify-content-center">
    <div class="col-lg-8">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">System Information</h5>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="mb-3">
                        <label for="name" class="form-label">System Name *</label>
                        <input type="text" class="form-control" id="name" name="name" required
                               value="{{ system.name }}" placeholder="e.g., Production-Server-01">
                        <div class="form-text">Unique identifier for this system</div>
                    </div>
                    
                    <div class="alert alert-info" id="rscmInfoAlert" style="display: none;">
                        <i class="bi bi-info-circle"></i> <strong>RSCM IP will be updated from rack:</strong>
                        <span id="rscmInfoText"></span>
                    </div>
                    
                    <input type="hidden" id="rscm_ip" name="rscm_ip" value="{{ system.rscm_ip }}">
                    
                    <div class="mb-3">
                        <label for="rscm_port" class="form-label">
                            <i class="bi bi-ethernet"></i> RSCM/Redfish Port <span class="text-danger">*</span>
                        </label>
                        <input type="number" class="form-control" id="rscm_port" name="rscm_port"
                               value="{{ system.rscm_port if system.rscm_port else '' }}"
                               placeholder="e.g., 22, 23, or 24" min="1" max="65535" required>
                        <div class="form-text">Port used to connect to RSCM or Redfish (varies by rack/system)</div>
                    </div>
                    
                    <hr class="my-4">
                    <h6><i class="bi bi-hdd-network"></i> System Details</h6>
                    
                    <div class="mb-3">
                        <label for="system_hostname" class="form-label">
                            <i class="bi bi-hdd-network"></i> System Hostname or IP Address
                        </label>
                        <input type="text" class="form-control" id="system_hostname" name="system_hostname"
                               value="{{ system_hostname or '' }}"
                               placeholder="e.g., server01.contoso.com or 10.18.64.94">
                        <div class="form-text">The hostname or IP address used to access this system</div>
                    </div>
                    
                    <hr class="my-4">
                    <h6><i class="bi bi-geo-alt"></i> Location Information</h6>
                    <p class="text-muted">Select the location where this system is physically installed</p>
                    
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <label for="citySelect" class="form-label">City <span class="text-danger">*</span></label>
                            <select class="form-select" id="citySelect" name="location_id" required onchange="updateBuildingOptions()">
                                <option value="">Select city...</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="buildingSelect" class="form-label">Building <span class="text-danger">*</span></label>
                            <select class="form-select" id="buildingSelect" name="building_id" required onchange="updateRoomOptions()" disabled>
                                <option value="">Select city first...</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="roomSelect" class="form-label">Room <span class="text-danger">*</span></label>
                            <select class="form-select" id="roomSelect" name="room_id" required onchange="updateRackOptions()" disabled>
                                <option value="">Select building first...</option>
                            </select>
                        </div>
                        
                        <div class="col-md-3 mb-3">
                            <label for="rackSelect" class="form-label">Rack <span class="text-danger">*</span></label>
                            <select class="form-select" id="rackSelect" name="rack_id" required disabled onchange="updateRSCMFromRack()">
                                <option value="">Select room first...</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <label for="u_height" class="form-label">U Position <span class="text-danger">*</span></label>
                            <input type="number" class="form-control" id="u_height" name="u_height"
                                   value="{{ u_height or '' }}"
                                   placeholder="e.g., 12" min="1" max="50" required>
                            <div class="form-text">Rack unit position (1-50)</div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="additional_notes" class="form-label">Additional Notes</label>
                        <textarea class="form-control" id="additional_notes" name="additional_notes" rows="3"
                                  placeholder="Any additional information about this system">{{ additional_notes or '' }}</textarea>
                        <div class="form-text">Optional additional information</div>
                    </div>
                    
                    <div class="mb-4">
                        <div class="card bg-light">
                            <div class="card-body">
                                <h6 class="card-title"><i class="bi bi-info-circle"></i> System History</h6>
                                <dl class="row mb-0">
                                    <dt class="col-sm-3">Created:</dt>
                                    <dd class="col-sm-9">{{ system.created_at[:19] if system.created_at else 'Unknown' }}</dd>
                                    <dt class="col-sm-3">Last Updated:</dt>
                                    <dd class="col-sm-9">{{ system.updated_at[:19] if system.updated_at else 'Unknown' }}</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('system_detail', system_id=system.id) }}" class="btn btn-secondary">
                            <i class="bi bi-x"></i> Cancel
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="bi bi-save"></i> Update System
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let allLocations = [];
let allBuildings = [];
let allRooms = [];
let allRacks = [];

// Current selections from database
const currentLocation = "{{ geo_location or '' }}";
const currentBuilding = "{{ building or '' }}";
const currentRoom = "{{ room or '' }}";
const currentRack = "{{ rack or '' }}";
const currentLocationId = {{ location_id if location_id else 'null' }};
const currentBuildingId = {{ building_id if building_id else 'null' }};
const currentRoomId = {{ room_id if room_id else 'null' }};
const currentRackId = {{ system.rack_id if system.rack_id else 'null' }};

// Load all location data
async function loadLocationData() {
    try {
        const [locationsResp, buildingsResp, roomsResp, racksResp] = await Promise.all([
            fetch('{{ url_for("get_locations") }}'),
            fetch('{{ url_for("get_buildings") }}'),
            fetch('{{ url_for("get_rooms") }}'),
            fetch('{{ url_for("get_racks") }}')
        ]);
        
        allLocations = await locationsResp.json();
        allBuildings = await buildingsResp.json();
        allRooms = await roomsResp.json();
        allRacks = await racksResp.json();
        
        // Initialize city dropdown
        populateCityOptions();
        
        // Pre-select current values if they exist
        if (currentRackId) {
            preselectCurrentLocation();
        }
        
    } catch (error) {
        console.error('Error loading location data:', error);
    }
}

function populateCityOptions() {
    const citySelect = document.getElementById('citySelect');
    citySelect.innerHTML = '<option value="">Select city...</option>';
    
    allLocations.forEach(loc => {
        const option = document.createElement('option');
        option.value = loc.id;
        option.textContent = loc.name;
        citySelect.appendChild(option);
    });
}

function updateBuildingOptions() {
    const cityId = document.getElementById('citySelect').value;
    const buildingSelect = document.getElementById('buildingSelect');
    const roomSelect = document.getElementById('roomSelect');
    const rackSelect = document.getElementById('rackSelect');
    
    // Reset dependent dropdowns
    buildingSelect.innerHTML = '<option value="">Select building...</option>';
    roomSelect.innerHTML = '<option value="">Select building first...</option>';
    rackSelect.innerHTML = '<option value="">Select room first...</option>';
    roomSelect.disabled = true;
    rackSelect.disabled = true;
    
    if (!cityId) {
        buildingSelect.disabled = true;
        return;
    }
    
    buildingSelect.disabled = false;
    const cityBuildings = allBuildings.filter(b => b.location_id == cityId);
    
    cityBuildings.forEach(building => {
        const option = document.createElement('option');
        option.value = building.id;
        option.textContent = building.name;
        buildingSelect.appendChild(option);
    });
}

function updateRoomOptions() {
    const buildingId = document.getElementById('buildingSelect').value;
    const roomSelect = document.getElementById('roomSelect');
    const rackSelect = document.getElementById('rackSelect');
    
    roomSelect.innerHTML = '<option value="">Select room...</option>';
    rackSelect.innerHTML = '<option value="">Select room first...</option>';
    rackSelect.disabled = true;
    
    if (!buildingId) {
        roomSelect.disabled = true;
        return;
    }
    
    roomSelect.disabled = false;
    const buildingRooms = allRooms.filter(r => r.building_id == buildingId);
    
    buildingRooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = room.name;
        roomSelect.appendChild(option);
    });
}

function updateRackOptions() {
    const roomId = document.getElementById('roomSelect').value;
    const rackSelect = document.getElementById('rackSelect');
    
    rackSelect.innerHTML = '<option value="">Select rack...</option>';
    
    if (!roomId) {
        rackSelect.disabled = true;
        return;
    }
    
    rackSelect.disabled = false;
    const roomRacks = allRacks.filter(r => r.room_id == roomId);
    
    roomRacks.forEach(rack => {
        const option = document.createElement('option');
        option.value = rack.id;
        option.textContent = rack.name;
        rackSelect.appendChild(option);
    });
}

function updateRSCMFromRack() {
    const rackId = document.getElementById('rackSelect').value;
    const rscmInfoAlert = document.getElementById('rscmInfoAlert');
    const rscmInfoText = document.getElementById('rscmInfoText');
    
    if (!rackId) {
        rscmInfoAlert.style.display = 'none';
        return;
    }
    
    const rack = allRacks.find(r => r.id == rackId);
    if (!rack) {
        rscmInfoAlert.style.display = 'none';
        return;
    }
    
    // Determine RSCM IP based on rack type
    let rscmIp = null;
    
    if (rack.rack_type === 'bench' && rack.rscm_ip) {
        // Bench uses single rscm_ip
        rscmIp = rack.rscm_ip;
    } else if (rack.rscm_upper_ip) {
        // Rack uses upper RSCM by default
        rscmIp = rack.rscm_upper_ip;
    } else if (rack.rscm_lower_ip) {
        // Fallback to lower RSCM
        rscmIp = rack.rscm_lower_ip;
    }
    
    if (rscmIp) {
        // Update hidden IP field only - user must set port manually
        document.getElementById('rscm_ip').value = rscmIp;
        
        // Show info alert with just the IP
        rscmInfoText.textContent = rscmIp;
        rscmInfoAlert.style.display = 'block';
    } else {
        rscmInfoAlert.style.display = 'none';
        console.warn('No RSCM IP configured for rack:', rack.name);
    }
}

function preselectCurrentLocation() {
    // Find the rack's full hierarchy
    const rack = allRacks.find(r => r.id == currentRackId);
    if (!rack) return;
    
    const room = allRooms.find(r => r.id == rack.room_id);
    if (!room) return;
    
    const building = allBuildings.find(b => b.id == room.building_id);
    if (!building) return;
    
    const location = allLocations.find(l => l.id == building.location_id);
    if (!location) return;
    
    // Set selections in order
    document.getElementById('citySelect').value = location.id;
    updateBuildingOptions();
    
    setTimeout(() => {
        document.getElementById('buildingSelect').value = building.id;
        updateRoomOptions();
        
        setTimeout(() => {
            document.getElementById('roomSelect').value = room.id;
            updateRackOptions();
            
            setTimeout(() => {
                document.getElementById('rackSelect').value = rack.id;
                // Update RSCM info after rack is selected
                updateRSCMFromRack();
            }, 50);
        }, 50);
    }, 50);
}

// Form validation
document.addEventListener('DOMContentLoaded', function() {
    // Load location data
    loadLocationData();
    
    const form = document.querySelector('form');
    
    // Form submission
    form.addEventListener('submit', function(e) {
        const name = document.getElementById('name').value.trim();
        const rackId = document.getElementById('rackSelect').value;
        
        if (!name) {
            e.preventDefault();
            alert('Please enter a system name');
            return;
        }
        
        if (!rackId) {
            e.preventDefault();
            alert('Please select a complete location (City > Building > Room > Rack)');
            return;
        }
    });
});
</script>
{% endblock %}