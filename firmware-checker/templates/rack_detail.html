{% extends "base.html" %}

{% block title %}{{ rack.name }} - Rack Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-box"></i> {{ rack.name }}</h1>
                <p class="text-muted">
                    <i class="bi bi-geo-alt"></i> {{ rack.location }}
                    {% if rack.room %}
                    | <i class="bi bi-door-closed"></i> {{ rack.room }}
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('racks') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Racks
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Rack Information -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Rack Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th width="30%">Name:</th>
                        <td>{{ rack.name }}</td>
                    </tr>
                    <tr>
                        <th>Location:</th>
                        <td>{{ rack.location }}</td>
                    </tr>
                    {% if rack.room %}
                    <tr>
                        <th>Room:</th>
                        <td>{{ rack.room }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Type:</th>
                        <td>
                            <span class="badge bg-{{ 'primary' if rack.rack_type == 'rack' else 'info' }}">
                                {{ rack.rack_type.title() }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Systems:</th>
                        <td>{{ system_count }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-hdd-network"></i> RSCM Components</h5>
            </div>
            <div class="card-body">
                {% if rscm_components %}
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>IP Address</th>
                                <th>Port</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rscm in rscm_components %}
                            <tr>
                                <td>
                                    <i class="bi bi-hdd-network-fill text-primary"></i>
                                    {{ rscm.name }}
                                </td>
                                <td>{{ rscm.ip_address }}</td>
                                <td>{{ rscm.port }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted text-center my-3">No RSCM components configured</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Active Check Alert -->
{% if active_check %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-hourglass-split"></i>
                <strong>Check in Progress</strong> - An RSCM firmware check is currently running.
            </div>
            <a href="{{ url_for('rscm_check_progress', check_id=active_check.id) }}" class="btn btn-sm btn-info">
                <i class="bi bi-eye"></i> View Progress
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- RSCM Firmware Check History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> RSCM Firmware Check History</h5>
                {% if rscm_components %}
                <button class="btn btn-success btn-sm" 
                        onclick="openRSCMCheckModal()">
                    <i class="bi bi-plus"></i> New Check
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if checks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Check Date</th>
                                    <th>Status</th>
                                    <th>RSCMs Checked</th>
                                    <th>Checked By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for check in checks %}
                                <tr>
                                    <td>{{ check.check_date[:19] }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if check.status == 'success' else ('warning' if check.status == 'running' else 'danger') }}">
                                            {{ check.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if check.firmware_data and check.firmware_data != '{}' %}
                                            {% if check.firmware_data_parsed and check.firmware_data_parsed.rscm_checks %}
                                                <span class="badge bg-info">
                                                    {{ check.firmware_data_parsed.rscm_checks.keys()|list|length }} RSCM(s)
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No data</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if check.username %}
                                            <i class="bi bi-person-circle"></i>
                                            {{ check.first_name or check.username }}
                                            {{ check.last_name or '' }}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if check.status == 'running' %}
                                                <a href="{{ url_for('rscm_check_progress', check_id=check.id) }}" 
                                                   class="btn btn-outline-info btn-sm"
                                                   title="View Progress">
                                                    <i class="bi bi-hourglass-split"></i>
                                                </a>
                                            {% elif check.firmware_data and check.firmware_data != '{}' %}
                                                <a href="{{ url_for('rscm_check_result', check_id=check.id) }}" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   title="View Results">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            {% endif %}
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    data-check-id="{{ check.id }}"
                                                    onclick="deleteRSCMCheck(this)"
                                                    title="Delete Check">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-clock-history fs-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">No RSCM Firmware Checks Yet</h4>
                        {% if rscm_components %}
                            <p class="text-muted">Run your first RSCM firmware check to see the results here</p>
                            <button class="btn btn-success"
                                    onclick="openRSCMCheckModal()">
                                <i class="bi bi-check-circle"></i> Run First Check
                            </button>
                        {% else %}
                            <p class="text-muted">No RSCM components configured for this rack</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function deleteRSCMCheck(button) {
    const checkId = button.getAttribute('data-check-id');
    
    if (!confirm('Are you sure you want to delete this RSCM firmware check? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/rscm-check/${checkId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error deleting check: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting check');
    });
}

function openRSCMCheckModal() {
    // Set rack information
    document.getElementById('rscmRackName').textContent = '{{ rack.name }}';
    document.getElementById('rscmRackId').value = {{ rack.id }};
    
    // Build RSCM list
    const rscmList = document.getElementById('rscmList');
    rscmList.innerHTML = '';
    
    {% if rscm_upper_ip %}
    document.getElementById('rscmUpperIp').value = '{{ rscm_upper_ip }}';
    rscmList.innerHTML += `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="upper" id="rscmUpper" checked>
            <label class="form-check-label" for="rscmUpper">
                <i class="bi bi-hdd-network"></i> Upper RSCM ({{ rscm_upper_ip }})
            </label>
        </div>
    `;
    {% endif %}
    
    {% if rscm_lower_ip %}
    document.getElementById('rscmLowerIp').value = '{{ rscm_lower_ip }}';
    rscmList.innerHTML += `
        <div class="form-check">
            <input class="form-check-input" type="checkbox" value="lower" id="rscmLower" checked>
            <label class="form-check-label" for="rscmLower">
                <i class="bi bi-hdd-network"></i> Lower RSCM ({{ rscm_lower_ip }})
            </label>
        </div>
    `;
    {% endif %}
    
    // Reset credentials section
    document.getElementById('rscmCredentialsSection').style.display = 'none';
    document.getElementById('rscmPassword').value = '';
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('rscmCheckModal'));
    modal.show();
}

function startRSCMCheck() {
    const rackId = document.getElementById('rscmRackId').value;
    const username = document.getElementById('rscmUsername').value;
    const password = document.getElementById('rscmPassword').value;
    const rscmUpperIp = document.getElementById('rscmUpperIp').value;
    const rscmLowerIp = document.getElementById('rscmLowerIp').value;
    
    // Get selected RSCMs
    const selectedRSCMs = [];
    const upperCheckbox = document.getElementById('rscmUpper');
    const lowerCheckbox = document.getElementById('rscmLower');
    
    if (upperCheckbox && upperCheckbox.checked && rscmUpperIp) {
        selectedRSCMs.push({ position: 'upper', ip: rscmUpperIp });
    }
    if (lowerCheckbox && lowerCheckbox.checked && rscmLowerIp) {
        selectedRSCMs.push({ position: 'lower', ip: rscmLowerIp });
    }
    
    // Validate
    if (selectedRSCMs.length === 0) {
        alert('Please select at least one RSCM to check');
        return;
    }
    
    if (!username || !password) {
        alert('Please enter RSCM credentials');
        return;
    }
    
    // Disable button and show loading
    const btn = document.getElementById('rscmCheckBtn');
    btn.disabled = true;
    btn.innerHTML = `
        <span class="spinner-border spinner-border-sm" role="status"></span>
        Starting...
    `;
    
    // Start check
    fetch('/api/check-rscm-firmware', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            rack_id: rackId,
            rscm_positions: selectedRSCMs,
            username: username,
            password: password
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'started') {
            // Redirect to progress page
            window.location.href = data.progress_url;
        } else {
            alert('Error starting RSCM firmware check: ' + (data.error || 'Unknown error'));
            btn.disabled = false;
            btn.innerHTML = `
                <i class="bi bi-play-fill"></i> Start Firmware Check
            `;
        }
    })
    .catch(error => {
        alert('Error: ' + error.message);
        btn.disabled = false;
        btn.innerHTML = `
            <i class="bi bi-play-fill"></i> Start Firmware Check
        `;
    });
}

function toggleRSCMCredentials() {
    const section = document.getElementById('rscmCredentialsSection');
    section.style.display = section.style.display === 'none' ? 'block' : 'none';
}
</script>

<!-- RSCM Firmware Check Modal -->
<div class="modal fade" id="rscmCheckModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title">
                    <i class="bi bi-hdd-network-fill"></i> Check RSCM Firmware
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <h6>Rack: <span id="rscmRackName"></span></h6>
                <hr>
                
                <!-- RSCM Selection -->
                <div class="mb-3">
                    <label class="form-label fw-bold">Select RSCMs to Check:</label>
                    <div id="rscmList"></div>
                </div>
                
                <!-- Credentials -->
                <div class="mb-3">
                    <button class="btn btn-sm btn-outline-secondary w-100" 
                            type="button" 
                            onclick="toggleRSCMCredentials()">
                        <i class="bi bi-key"></i> Enter RSCM Credentials
                    </button>
                </div>
                
                <div id="rscmCredentialsSection" style="display: none;">
                    <div class="card mb-3">
                        <div class="card-body">
                            <div class="mb-2">
                                <label for="rscmUsername" class="form-label">RSCM Username</label>
                                <input type="text" 
                                       class="form-control" 
                                       id="rscmUsername" 
                                       value="root" 
                                       autocomplete="off">
                            </div>
                            <div class="mb-2">
                                <label for="rscmPassword" class="form-label">RSCM Password</label>
                                <input type="password" 
                                       class="form-control" 
                                       id="rscmPassword" 
                                       placeholder="Enter password"
                                       autocomplete="off">
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Hidden fields -->
                <input type="hidden" id="rscmRackId">
                <input type="hidden" id="rscmUpperIp">
                <input type="hidden" id="rscmLowerIp">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" 
                        id="rscmCheckBtn"
                        class="btn btn-success" 
                        onclick="startRSCMCheck()">
                    <i class="bi bi-play-fill"></i> Start Firmware Check
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}
