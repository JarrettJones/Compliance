{% extends "base.html" %}

{% block title %}{{ rack.name }} - Rack Details{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-box"></i> {{ rack.name }}</h1>
                <p class="text-muted">
                    <i class="bi bi-geo-alt"></i> {{ rack.location }}
                    {% if rack.room %}
                    | <i class="bi bi-door-closed"></i> {{ rack.room }}
                    {% endif %}
                </p>
            </div>
            <div>
                <a href="{{ url_for('racks') }}" class="btn btn-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Racks
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Rack Information -->
<div class="row mb-4">
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Rack Information</h5>
            </div>
            <div class="card-body">
                <table class="table table-sm">
                    <tr>
                        <th width="30%">Name:</th>
                        <td>{{ rack.name }}</td>
                    </tr>
                    <tr>
                        <th>Location:</th>
                        <td>{{ rack.location }}</td>
                    </tr>
                    {% if rack.room %}
                    <tr>
                        <th>Room:</th>
                        <td>{{ rack.room }}</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <th>Type:</th>
                        <td>
                            <span class="badge bg-{{ 'primary' if rack.rack_type == 'rack' else 'info' }}">
                                {{ rack.rack_type.title() }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <th>Systems:</th>
                        <td>{{ system_count }}</td>
                    </tr>
                </table>
            </div>
        </div>
    </div>
    
    <div class="col-md-6">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-hdd-network"></i> RSCM Components</h5>
            </div>
            <div class="card-body">
                {% if rscm_components %}
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Position</th>
                                <th>IP Address</th>
                                <th>Port</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for rscm in rscm_components %}
                            <tr>
                                <td>
                                    <i class="bi bi-hdd-network-fill text-primary"></i>
                                    {{ rscm.name }}
                                </td>
                                <td>{{ rscm.ip_address }}</td>
                                <td>{{ rscm.port }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                {% else %}
                    <p class="text-muted text-center my-3">No RSCM components configured</p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Active Check Alert -->
{% if active_check %}
<div class="row mb-4">
    <div class="col-12">
        <div class="alert alert-info d-flex justify-content-between align-items-center">
            <div>
                <i class="bi bi-hourglass-split"></i>
                <strong>Check in Progress</strong> - An RSCM firmware check is currently running.
            </div>
            <a href="{{ url_for('rscm_check_progress', check_id=active_check.id) }}" class="btn btn-sm btn-info">
                <i class="bi bi-eye"></i> View Progress
            </a>
        </div>
    </div>
</div>
{% endif %}

<!-- RSCM Firmware Check History -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clock-history"></i> RSCM Firmware Check History</h5>
                {% if rscm_components %}
                <button class="btn btn-success btn-sm" 
                        onclick="window.location.href='{{ url_for('racks') }}'; setTimeout(() => checkRSCMFirmware({{ rack.id }}, '{{ rack.name }}', '{{ rscm_components|selectattr('name', 'search', 'upper')|map(attribute='ip_address')|first or '' }}', '{{ rscm_components|selectattr('name', 'search', 'lower')|map(attribute='ip_address')|first or '' }}'), 500)">
                    <i class="bi bi-plus"></i> New Check
                </button>
                {% endif %}
            </div>
            <div class="card-body">
                {% if checks %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Check Date</th>
                                    <th>Status</th>
                                    <th>RSCMs Checked</th>
                                    <th>Checked By</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for check in checks %}
                                <tr>
                                    <td>{{ check.check_date[:19] }}</td>
                                    <td>
                                        <span class="badge bg-{{ 'success' if check.status == 'success' else ('warning' if check.status == 'running' else 'danger') }}">
                                            {{ check.status.title() }}
                                        </span>
                                    </td>
                                    <td>
                                        {% if check.firmware_data and check.firmware_data != '{}' %}
                                            {% set fw_data = check.firmware_data|from_json %}
                                            {% if fw_data and fw_data.rscm_checks %}
                                                <span class="badge bg-info">
                                                    {{ fw_data.rscm_checks.keys()|list|length }} RSCM(s)
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        {% else %}
                                            <span class="text-muted">No data</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if check.username %}
                                            <i class="bi bi-person-circle"></i>
                                            {{ check.first_name or check.username }}
                                            {{ check.last_name or '' }}
                                        {% else %}
                                            <span class="text-muted">Unknown</span>
                                        {% endif %}
                                    </td>
                                    <td>
                                        <div class="btn-group" role="group">
                                            {% if check.status == 'running' %}
                                                <a href="{{ url_for('rscm_check_progress', check_id=check.id) }}" 
                                                   class="btn btn-outline-info btn-sm"
                                                   title="View Progress">
                                                    <i class="bi bi-hourglass-split"></i>
                                                </a>
                                            {% elif check.firmware_data and check.firmware_data != '{}' %}
                                                <a href="{{ url_for('rscm_check_result', check_id=check.id) }}" 
                                                   class="btn btn-outline-primary btn-sm"
                                                   title="View Results">
                                                    <i class="bi bi-eye"></i>
                                                </a>
                                            {% endif %}
                                            <button class="btn btn-outline-danger btn-sm" 
                                                    data-check-id="{{ check.id }}"
                                                    onclick="deleteRSCMCheck(this)"
                                                    title="Delete Check">
                                                <i class="bi bi-trash"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <div class="text-center py-5">
                        <i class="bi bi-clock-history fs-1 text-muted"></i>
                        <h4 class="mt-3 text-muted">No RSCM Firmware Checks Yet</h4>
                        {% if rscm_components %}
                            <p class="text-muted">Run your first RSCM firmware check to see the results here</p>
                            <button class="btn btn-success"
                                    onclick="window.location.href='{{ url_for('racks') }}'; setTimeout(() => checkRSCMFirmware({{ rack.id }}, '{{ rack.name }}', '{{ rscm_components|selectattr('name', 'search', 'upper')|map(attribute='ip_address')|first or '' }}', '{{ rscm_components|selectattr('name', 'search', 'lower')|map(attribute='ip_address')|first or '' }}'), 500)">
                                <i class="bi bi-check-circle"></i> Run First Check
                            </button>
                        {% else %}
                            <p class="text-muted">No RSCM components configured for this rack</p>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
function deleteRSCMCheck(button) {
    const checkId = button.getAttribute('data-check-id');
    
    if (!confirm('Are you sure you want to delete this RSCM firmware check? This action cannot be undone.')) {
        return;
    }
    
    fetch(`/api/rscm-check/${checkId}`, {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error deleting check: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('Error deleting check');
    });
}
</script>
{% endblock %}
