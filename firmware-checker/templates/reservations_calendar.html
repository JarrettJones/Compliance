{% extends "base.html" %}

{% block title %}Reservations Calendar - Firmware Version Checker{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row mb-4">
        <div class="col">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h2><i class="bi bi-calendar3"></i> Reservations Calendar</h2>
                    <p class="text-muted">View all system reservations in calendar format</p>
                </div>
                <div>
                    <a href="{{ url_for('reservations') }}" class="btn btn-outline-secondary">
                        <i class="bi bi-list-ul"></i> List View
                    </a>
                </div>
            </div>
        </div>
    </div>
    
    <div class="row mb-3">
        <div class="col">
            <div class="alert alert-info">
                <i class="bi bi-info-circle"></i> 
                <strong>Legend:</strong> 
                <span class="badge bg-primary">Your Reservations</span>
                <span class="badge bg-secondary ms-2">Other Users' Reservations</span>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <div class="card">
                <div class="card-body">
                    <div id="calendar"></div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- FullCalendar CSS -->
<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.css" rel="stylesheet">

<!-- FullCalendar JS -->
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>

<style>
    #calendar {
        max-width: 100%;
        margin: 0 auto;
    }
    
    .fc-event {
        cursor: pointer;
    }
    
    .fc-event:hover {
        opacity: 0.8;
    }
    
    /* Make calendar responsive */
    .fc-toolbar {
        flex-wrap: wrap;
        gap: 10px;
    }
    
    .fc-toolbar-chunk {
        margin: 5px 0;
    }
    
    /* Better mobile view */
    @media (max-width: 768px) {
        .fc-toolbar-title {
            font-size: 1.2em !important;
        }
        
        .fc-button {
            padding: 0.3em 0.5em !important;
            font-size: 0.9em !important;
        }
    }
</style>

<script>
const SCRIPT_ROOT = {{ request.script_root|tojson|safe }};

document.addEventListener('DOMContentLoaded', function() {
    const calendarEl = document.getElementById('calendar');
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        height: 'auto',
        navLinks: true,
        editable: false,
        selectable: false,
        selectMirror: true,
        dayMaxEvents: true,
        weekends: true,
        
        // Fetch events from API
        events: function(info, successCallback, failureCallback) {
            fetch(`${SCRIPT_ROOT}/api/reservations/calendar-events?start=${info.startStr}&end=${info.endStr}`)
                .then(response => response.json())
                .then(data => successCallback(data))
                .catch(error => {
                    console.error('Error loading calendar events:', error);
                    failureCallback(error);
                });
        },
        
        // Event click handler
        eventClick: function(info) {
            const event = info.event;
            const props = event.extendedProps;
            
            let html = `
                <div class="modal fade" id="eventModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title">
                                    <i class="bi bi-calendar-event"></i> Reservation Details
                                </h5>
                                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                            </div>
                            <div class="modal-body">
                                <dl class="row">
                                    <dt class="col-sm-4">System:</dt>
                                    <dd class="col-sm-8">
                                        <a href="${SCRIPT_ROOT}/systems/${props.systemId}" target="_blank">
                                            ${props.systemName}
                                        </a>
                                    </dd>
                                    
                                    <dt class="col-sm-4">Reserved By:</dt>
                                    <dd class="col-sm-8">
                                        ${props.username}
                                        ${props.isMine ? '<span class="badge bg-primary ms-1">You</span>' : ''}
                                    </dd>
                                    
                                    <dt class="col-sm-4">Start Time:</dt>
                                    <dd class="col-sm-8">${formatDateTime(event.start)}</dd>
                                    
                                    <dt class="col-sm-4">End Time:</dt>
                                    <dd class="col-sm-8">${formatDateTime(event.end)}</dd>
                                    
                                    <dt class="col-sm-4">Duration:</dt>
                                    <dd class="col-sm-8">${calculateDuration(event.start, event.end)}</dd>
                                    
                                    ${props.purpose ? `
                                        <dt class="col-sm-4">Purpose:</dt>
                                        <dd class="col-sm-8">${escapeHtml(props.purpose)}</dd>
                                    ` : ''}
                                </dl>
                            </div>
                            <div class="modal-footer">
                                ${props.isMine && event.end > new Date() ? `
                                    <button type="button" class="btn btn-danger" onclick="cancelReservation(${event.id})">
                                        <i class="bi bi-x-circle"></i> Cancel Reservation
                                    </button>
                                ` : ''}
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Remove any existing modal
            const existingModal = document.getElementById('eventModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Add new modal to body
            document.body.insertAdjacentHTML('beforeend', html);
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('eventModal'));
            modal.show();
            
            // Clean up modal after it's hidden
            document.getElementById('eventModal').addEventListener('hidden.bs.modal', function() {
                this.remove();
            });
        },
        
        // Customize event rendering
        eventDidMount: function(info) {
            // Add tooltip
            info.el.title = `${info.event.extendedProps.systemName} - ${info.event.extendedProps.username}`;
        }
    });
    
    calendar.render();
    
    // Store calendar instance globally for potential updates
    window.reservationCalendar = calendar;
});

function formatDateTime(date) {
    return date.toLocaleString('en-US', {
        month: '2-digit',
        day: '2-digit',
        year: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        hour12: true
    });
}

function calculateDuration(start, end) {
    const diffMs = end - start;
    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
    const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
    
    if (diffHours > 24) {
        const days = Math.floor(diffHours / 24);
        const hours = diffHours % 24;
        return `${days}d ${hours}h`;
    }
    
    return `${diffHours}h ${diffMinutes}m`;
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

async function cancelReservation(reservationId) {
    if (!confirm('Are you sure you want to cancel this reservation?')) {
        return;
    }
    
    try {
        const response = await fetch(`${SCRIPT_ROOT}/api/reservations/${reservationId}/cancel`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const result = await response.json();
        
        if (response.ok) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('eventModal'));
            if (modal) modal.hide();
            
            // Refresh calendar
            window.reservationCalendar.refetchEvents();
            
            // Show success message
            showAlert('Reservation cancelled successfully!', 'success');
        } else {
            showAlert(result.error || 'Error cancelling reservation', 'danger');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('Error cancelling reservation', 'danger');
    }
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed top-0 start-50 translate-middle-x mt-3" role="alert" style="z-index: 9999;">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.body.insertAdjacentHTML('beforeend', alertHtml);
    
    // Auto-dismiss after 3 seconds
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            const bsAlert = new bootstrap.Alert(alert);
            bsAlert.close();
        }
    }, 3000);
}
</script>
{% endblock %}
