{% extends "base.html" %}

{% block title %}Systems - Firmware Version Checker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-server"></i> Systems</h1>
                <p class="lead">Manage your systems and their firmware checking</p>
            </div>
            <div>
                <button id="bulkCheckBtn" class="btn btn-success me-2" style="display: none;" onclick="startBulkCheck()">
                    <i class="bi bi-check-circle-fill"></i> Check Selected (<span id="selectedCount">0</span>)
                </button>
                <a href="{{ url_for('add_system') }}" class="btn btn-primary">
                    <i class="bi bi-plus"></i> Add System
                </a>
            </div>
        </div>
    </div>
</div>

{% if systems %}
<div class="row mb-3">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="row g-3">
                    <!-- Search Bar -->
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text"><i class="bi bi-search"></i></span>
                            <input type="text" class="form-control" id="searchInput" 
                                   placeholder="Search systems, IPs, locations...">
                        </div>
                    </div>
                    
                    <!-- Group By Filter -->
                    <div class="col-md-2">
                        <select class="form-select" id="groupByFilter">
                            <option value="none">No Grouping</option>
                            <option value="tree" selected>Tree View</option>
                            <option value="location">Group by Location</option>
                            <option value="building">Group by Building</option>
                            <option value="rack">Group by Rack</option>
                        </select>
                    </div>
                    
                    <!-- Created By Filter -->
                    <div class="col-md-2">
                        <select class="form-select" id="createdByFilter">
                            <option value="all">All Creators</option>
                            <option value="me">My Systems</option>
                            {% for creator in creators %}
                            <option value="{{ creator.user_id }}">
                                {% if creator.first_name and creator.last_name %}
                                    {{ creator.first_name }} {{ creator.last_name }}
                                {% else %}
                                    {{ creator.username }}
                                {% endif %}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <!-- Sort By -->
                    <div class="col-md-3">
                        <select class="form-select" id="sortByFilter">
                            <option value="name-asc">Name (A-Z)</option>
                            <option value="name-desc">Name (Z-A)</option>
                            <option value="checks-desc">Most Checks</option>
                            <option value="checks-asc">Least Checks</option>
                            <option value="recent">Recently Checked</option>
                        </select>
                    </div>
                    
                    <!-- Results Count -->
                    <div class="col-md-2">
                        <div class="text-muted text-center mt-2">
                            <strong><span id="visibleCount">{{ systems|length }}</span></strong> 
                            <span class="small">of {{ systems|length }} systems</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <div id="systemsContainer">
            <!-- Systems will be rendered here by JavaScript -->
        </div>
        
        <!-- No Results Message -->
        <div id="noResultsMessage" class="card" style="display: none;">
            <div class="card-body text-center py-5">
                <i class="bi bi-search fs-1 text-muted"></i>
                <h3 class="mt-3 text-muted">No Systems Found</h3>
                <p class="text-muted">Try adjusting your search or filters</p>
                <button class="btn btn-outline-primary" onclick="clearFilters()">
                    <i class="bi bi-x-circle"></i> Clear Filters
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Hidden template for ungrouped table -->
<template id="ungroupedTableTemplate">
    <div class="card">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th style="width: 40px;">
                                <input type="checkbox" id="selectAllCheckbox" onchange="toggleSelectAll(this)">
                            </th>
                            <th>System Name</th>
                            <th>RSCM IP</th>
                            <th>Port</th>
                            <th>Location</th>
                            <th>Checks</th>
                            <th>Last Check</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="systemsTableBody">
                        <!-- Rows inserted by JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</template>

<!-- Original systems data for JavaScript -->
<script id="systemsData" type="application/json">
{{ systems|tojson }}
</script>

<!-- Systems list container (dynamically populated by JavaScript) -->
<div id="systemsListContainer" class="row">
    <!-- Content will be generated by filterAndSortSystems() -->
</div>

<!-- Old template code - kept for reference but not displayed -->
<!--
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>System Name</th>
                                <th>RSCM IP</th>
                                <th>Port</th>
                                <th>Description</th>
                                <th>Checks</th>
                                <th>Last Check</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for system in systems %}
                            <tr>
                                <td>
                                    <strong>{{ system.name }}</strong>
                                </td>
                                <td>
                                    <code>{{ system.rscm_ip }}</code>
                                </td>
                                <td>
                                    <span class="badge bg-secondary">{{ system.rscm_port }}</span>
                                </td>
                                <td>
                                    <span class="text-muted">{{ system.description or 'No description' }}</span>
                                </td>
                                <td>
                                    <span class="badge bg-info">{{ system.check_count }}</span>
                                </td>
                                <td>
                                    {% if system.last_check %}
                                        <small class="text-muted">{{ system.last_check[:19] }}</small>
                                    {% else %}
                                        <small class="text-warning">Never</small>
                                    {% endif %}
                                </td>
                                <td>
                                    <div class="btn-group" role="group">
                                        <a href="{{ url_for('system_detail', system_id=system.id) }}" 
                                           class="btn btn-outline-primary btn-sm" title="View Details">
                                            <i class="bi bi-eye"></i>
                                        </a>
                                        <a href="{{ url_for('check_firmware', system_id=system.id) }}" 
                                           class="btn btn-outline-success btn-sm" title="Check Firmware">
                                            <i class="bi bi-check-circle"></i>
                                        </a>
                                        <a href="{{ url_for('edit_system', system_id=system.id) }}" 
                                           class="btn btn-outline-secondary btn-sm" title="Edit System">
                                            <i class="bi bi-pencil"></i>
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm" title="Delete" 
                                                data-system-name="{{ system.name }}" 
                                                data-system-id="{{ system.id }}"
                                                onclick="confirmDelete(this)">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
-->
{% else %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body text-center py-5">
                <i class="bi bi-server fs-1 text-muted"></i>
                <h3 class="mt-3 text-muted">No Systems Configured</h3>
                <p class="text-muted">Add your first system to start monitoring firmware versions</p>
                <a href="{{ url_for('add_system') }}" class="btn btn-primary btn-lg">
                    <i class="bi bi-plus"></i> Add Your First System
                </a>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Delete Confirmation Modal (placed after content block, will render after </main>) -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Confirm Delete</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete the system <strong id="deleteSystemName"></strong>?</p>
                <p class="text-warning">This will also delete all firmware check history for this system.</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <form id="deleteForm" method="POST" style="display: inline;">
                    <button type="submit" class="btn btn-danger">Delete System</button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Get the script root for URL generation (handles /firmware-checker prefix)
const SCRIPT_ROOT = {{ request.script_root|tojson }};

// Load systems data
let systemsData = JSON.parse(document.getElementById('systemsData').textContent);

// Parse metadata from description
function parseMetadata(description) {
    const metadata = {
        hostname: '',
        location: '',
        building: '',
        room: '',
        rack: '',
        u_height: '',
        notes: ''
    };
    
    if (!description) return metadata;
    
    const parts = description.split('|');
    for (let part of parts) {
        part = part.trim();
        if (part.startsWith('Host:')) {
            metadata.hostname = part.replace('Host:', '').trim();
        } else if (part.startsWith('Geo:')) {
            metadata.location = part.replace('Geo:', '').trim();
        } else if (part.startsWith('Building:')) {
            metadata.building = part.replace('Building:', '').trim();
        } else if (part.startsWith('Room:')) {
            metadata.room = part.replace('Room:', '').trim();
        } else if (part.startsWith('Rack:')) {
            metadata.rack = part.replace('Rack:', '').trim();
        } else if (part.startsWith('U:')) {
            metadata.u_height = part.replace('U:', '').trim();
        } else if (!part.includes(':')) {
            metadata.notes = part;
        }
    }
    
    return metadata;
}

// Generate action buttons HTML
function generateActionButtons(system) {
    return `
        <div class="btn-group" role="group">
            <a href="${SCRIPT_ROOT}/systems/${system.id}" 
               class="btn btn-outline-primary btn-sm" title="View Details">
                <i class="bi bi-eye"></i>
            </a>
            <a href="${SCRIPT_ROOT}/check/${system.id}" 
               class="btn btn-outline-success btn-sm" title="Check Firmware">
                <i class="bi bi-check-circle"></i>
            </a>
            <a href="${SCRIPT_ROOT}/systems/${system.id}/edit" 
               class="btn btn-outline-secondary btn-sm" title="Edit System">
                <i class="bi bi-pencil"></i>
            </a>
            <button class="btn btn-outline-danger btn-sm" title="Delete" 
                    data-bs-toggle="modal" 
                    data-bs-target="#deleteModal"
                    data-system-name="${system.name}" 
                    data-system-id="${system.id}">
                <i class="bi bi-trash"></i>
            </button>
        </div>
    `;
}

// Generate table row
function generateTableRow(system) {
    const metadata = parseMetadata(system.description);
    const locationInfo = [metadata.location, metadata.building, metadata.room].filter(x => x).join(', ') || 'Not specified';
    const lastCheck = system.last_check ? system.last_check.substring(0, 19) : '<small class="text-warning">Never</small>';
    
    // Format created by info
    let createdByInfo = '';
    if (system.created_by_username) {
        if (system.created_by_first_name && system.created_by_last_name) {
            createdByInfo = `<br><small class="text-muted"><i class="bi bi-person-plus"></i> ${system.created_by_first_name} ${system.created_by_last_name}</small>`;
        } else {
            createdByInfo = `<br><small class="text-muted"><i class="bi bi-person-plus"></i> ${system.created_by_username}</small>`;
        }
    }
    
    return `
        <tr>
            <td>
                <input type="checkbox" class="system-checkbox" value="${system.id}" onchange="updateSelectedCount()">
            </td>
            <td>
                <strong>${system.name}</strong>
                ${metadata.hostname ? `<br><small class="text-muted">(${metadata.hostname})</small>` : ''}
                ${createdByInfo}
            </td>
            <td><code>${system.rscm_ip}</code></td>
            <td><span class="badge bg-secondary">${system.rscm_port}</span></td>
            <td><small class="text-muted">${locationInfo}</small></td>
            <td><span class="badge bg-info">${system.check_count}</span></td>
            <td><small class="text-muted">${lastCheck}</small></td>
            <td>${generateActionButtons(system)}</td>
        </tr>
    `;
}

// Render ungrouped systems
function renderUngrouped(systems) {
    const container = document.getElementById('systemsContainer');
    const template = document.getElementById('ungroupedTableTemplate');
    const clone = template.content.cloneNode(true);
    
    container.innerHTML = '';
    container.appendChild(clone);
    
    const tbody = document.getElementById('systemsTableBody');
    tbody.innerHTML = systems.map(s => generateTableRow(s)).join('');
}

// Extract numeric U-height for sorting (e.g., "U10" -> 10, "40" -> 40)
function parseUHeight(uHeight) {
    if (!uHeight) return 999999; // Put systems without U-height at the end
    const match = uHeight.match(/(\d+)/);
    return match ? parseInt(match[1]) : 999999;
}

// Render rack view with U-height grouping
function renderRackView(systems) {
    const container = document.getElementById('systemsContainer');
    container.innerHTML = '';
    
    // Group by rack first
    const racks = {};
    systems.forEach(system => {
        const rackName = system.rack_name || 'No Rack';
        if (!racks[rackName]) {
            racks[rackName] = [];
        }
        racks[rackName].push(system);
    });
    
    // Sort racks alphabetically (but "No Rack" last)
    const sortedRacks = Object.keys(racks).sort((a, b) => {
        if (a === 'No Rack') return 1;
        if (b === 'No Rack') return -1;
        return a.localeCompare(b);
    });
    
    // Render each rack
    sortedRacks.forEach(rackName => {
        const rackSystems = racks[rackName];
        
        // Group systems by U-height within the rack
        const uGroups = {};
        rackSystems.forEach(system => {
            const uHeight = system.u_height || 'No U-Height';
            if (!uGroups[uHeight]) {
                uGroups[uHeight] = [];
            }
            uGroups[uHeight].push(system);
        });
        
        // Sort U-heights numerically
        const sortedUHeights = Object.keys(uGroups).sort((a, b) => {
            if (a === 'No U-Height') return 1;
            if (b === 'No U-Height') return -1;
            return parseUHeight(a) - parseUHeight(b);
        });
        
        // Generate rack card
        let rackHtml = `
            <div class="card mb-3">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="bi bi-server"></i> ${rackName}
                        <span class="badge bg-light text-dark ms-2">${rackSystems.length} systems</span>
                    </h5>
                </div>
                <div class="card-body p-0">
        `;
        
        // Render each U-height group
        sortedUHeights.forEach((uHeight, index) => {
            const uSystems = uGroups[uHeight];
            const isMultiple = uSystems.length > 1;
            const collapseId = `collapse-${rackName.replace(/\s+/g, '-')}-${uHeight.replace(/\s+/g, '-')}`;
            const displayUHeight = uHeight === 'No U-Height' ? uHeight : `U${uHeight}`;
            
            // Always show as expandable table format, even for single systems
            rackHtml += `
                <div class="border-bottom">
                    <div class="d-flex align-items-center p-2 bg-light">
                        <button class="btn btn-sm btn-outline-secondary me-2" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                            <i class="bi bi-chevron-down"></i>
                        </button>
                        <strong>${displayUHeight}</strong>
                        ${isMultiple ? `<span class="badge bg-secondary ms-2">${uSystems.length} blades</span>` : ''}
                    </div>
                    <div class="collapse" id="${collapseId}">
                        <div class="table-responsive">
                            <table class="table table-hover table-sm mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th style="width: 40px;">
                                            <input type="checkbox" class="group-select-all" onchange="toggleGroupSelectAll(this)">
                                        </th>
                                        <th>System Name</th>
                                        <th>RSCM IP</th>
                                        <th>Port</th>
                                        <th>Checks</th>
                                        <th>Last Check</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${uSystems.map(s => generateCompactTableRow(s)).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
        });
        
        rackHtml += `
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', rackHtml);
    });
}

// Generate compact table row for blade systems
function generateCompactTableRow(system) {
    const metadata = parseMetadata(system.description);
    const lastCheck = system.last_check ? system.last_check.substring(0, 19) : '<small class="text-warning">Never</small>';
    
    return `
        <tr>
            <td>
                <input type="checkbox" class="system-checkbox" value="${system.id}" onchange="updateSelectedCount()">
            </td>
            <td>
                <strong>${system.name}</strong>
                ${metadata.hostname ? `<br><small class="text-muted">(${metadata.hostname})</small>` : ''}
            </td>
            <td><code>${system.rscm_ip}</code></td>
            <td><span class="badge bg-secondary">${system.rscm_port}</span></td>
            <td><span class="badge bg-info">${system.check_count}</span></td>
            <td><small class="text-muted">${lastCheck}</small></td>
            <td>${generateActionButtons(system)}</td>
        </tr>
    `;
}

// Render hierarchical tree view: Location -> Building -> Room -> Rack -> U-Height -> Systems
function renderTreeView(systems) {
    const container = document.getElementById('systemsContainer');
    container.innerHTML = '';
    
    // Build hierarchy: location -> building -> room -> rack -> u_height -> systems
    const tree = {};
    
    systems.forEach(system => {
        const metadata = parseMetadata(system.description);
        const location = metadata.location || system.rack_location || 'Unknown Location';
        const building = metadata.building || 'Unknown Building';
        const room = system.rack_room || 'Unknown Room';
        const rackName = system.rack_name || 'No Rack';
        const uHeight = system.u_height || 'No U-Height';
        
        // Build tree structure
        if (!tree[location]) tree[location] = {};
        if (!tree[location][building]) tree[location][building] = {};
        if (!tree[location][building][room]) tree[location][building][room] = {};
        if (!tree[location][building][room][rackName]) tree[location][building][room][rackName] = {};
        if (!tree[location][building][room][rackName][uHeight]) tree[location][building][room][rackName][uHeight] = [];
        
        tree[location][building][room][rackName][uHeight].push(system);
    });
    
    // Sort locations
    const sortedLocations = Object.keys(tree).sort((a, b) => {
        if (a === 'Unknown Location') return 1;
        if (b === 'Unknown Location') return -1;
        return a.localeCompare(b);
    });
    
    // Render tree
    sortedLocations.forEach((location, locIndex) => {
        const buildings = tree[location];
        const sortedBuildings = Object.keys(buildings).sort();
        
        let locationHtml = `
            <div class="card mb-3">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; cursor: pointer;"
                     data-bs-toggle="collapse" data-bs-target="#location-${locIndex}">
                    <h5 class="mb-0 d-flex align-items-center">
                        <i class="bi bi-chevron-right me-2" id="icon-location-${locIndex}"></i>
                        <i class="bi bi-geo-alt-fill me-2"></i>
                        ${location}
                        <span class="badge bg-light text-dark ms-2">${Object.keys(buildings).length} building(s)</span>
                        <small class="ms-auto text-white-50">Click to expand</small>
                    </h5>
                </div>
                <div class="collapse" id="location-${locIndex}"
                     data-bs-parent="#systemsContainer">
                    <div class="card-body p-0">
        `;
        
        sortedBuildings.forEach((building, bldgIndex) => {
            const rooms = buildings[building];
            const sortedRooms = Object.keys(rooms).sort();
            
            locationHtml += `
                <div class="border-bottom">
                    <div class="p-2" style="background-color: #f8f9fa; cursor: pointer;"
                         data-bs-toggle="collapse" data-bs-target="#building-${locIndex}-${bldgIndex}">
                        <i class="bi bi-chevron-right me-2" id="icon-building-${locIndex}-${bldgIndex}"></i>
                        <i class="bi bi-building me-2"></i>
                        <strong>${building}</strong>
                        <span class="badge bg-secondary ms-2">${Object.keys(rooms).length} room(s)</span>
                        <small class="text-muted ms-2">Click to expand</small>
                    </div>
                    <div class="collapse" id="building-${locIndex}-${bldgIndex}">
            `;
            
            sortedRooms.forEach((room, roomIndex) => {
                const racks = rooms[room];
                const sortedRacks = Object.keys(racks).sort();
                
                locationHtml += `
                    <div class="ms-2 border-bottom">
                        <div class="p-2" style="background-color: #f0f0f0; cursor: pointer;"
                             data-bs-toggle="collapse" data-bs-target="#room-${locIndex}-${bldgIndex}-${roomIndex}">
                            <i class="bi bi-chevron-right me-2" id="icon-room-${locIndex}-${bldgIndex}-${roomIndex}"></i>
                            <i class="bi bi-door-open me-2"></i>
                            <strong>${room}</strong>
                            <span class="badge bg-secondary ms-2">${Object.keys(racks).length} rack(s)</span>
                            <small class="text-muted ms-2">Click to expand</small>
                        </div>
                        <div class="collapse" id="room-${locIndex}-${bldgIndex}-${roomIndex}">
                `;
            
                sortedRacks.forEach((rackName, rackIndex) => {
                    const uGroups = racks[rackName];
                    const sortedUHeights = Object.keys(uGroups).sort((a, b) => {
                        if (a === 'No U-Height') return 1;
                        if (b === 'No U-Height') return -1;
                        return parseInt(a) - parseInt(b);
                    });
                    
                    // Calculate total servers in this rack
                    const totalServers = sortedUHeights.reduce((sum, uHeight) => sum + uGroups[uHeight].length, 0);
                
                    locationHtml += `
                        <div class="ms-3 border-start border-3 border-primary">
                            <div class="p-2" style="background-color: #e9ecef; cursor: pointer;"
                                 data-bs-toggle="collapse" data-bs-target="#rack-${locIndex}-${bldgIndex}-${roomIndex}-${rackIndex}">
                                <i class="bi bi-chevron-right me-2" id="icon-rack-${locIndex}-${bldgIndex}-${roomIndex}-${rackIndex}"></i>
                                <i class="bi bi-hdd-rack me-2"></i>
                                <strong>${rackName}</strong>
                                <span class="badge bg-info ms-2">${totalServers} server${totalServers !== 1 ? 's' : ''}</span>
                                <small class="text-muted ms-2">Click to expand</small>
                            </div>
                            <div class="collapse" id="rack-${locIndex}-${bldgIndex}-${roomIndex}-${rackIndex}">
                    `;
                    
                    sortedUHeights.forEach((uHeight, uIndex) => {
                        const uSystems = uGroups[uHeight];
                        const displayUHeight = uHeight === 'No U-Height' ? uHeight : `U${uHeight}`;
                        const collapseId = `tree-u-${locIndex}-${bldgIndex}-${roomIndex}-${rackIndex}-${uIndex}`;
                    
                    locationHtml += `
                        <div class="ms-3 border-bottom">
                            <div class="p-2 bg-light" style="cursor: pointer;"
                                 data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <i class="bi bi-chevron-right me-2" id="icon-${collapseId}"></i>
                                <strong>${displayUHeight}</strong>
                                ${uSystems.length > 1 ? `<span class="badge bg-secondary ms-2">${uSystems.length} systems</span>` : `<span class="badge bg-secondary ms-2">1 system</span>`}
                                <small class="text-muted ms-2">Click to expand</small>
                            </div>
                            <div class="collapse" id="${collapseId}">
                                <div class="table-responsive">
                                    <table class="table table-hover table-sm mb-0">
                                        <thead class="table-light">
                                            <tr>
                                                <th style="width: 40px;">
                                                    <input type="checkbox" class="group-select-all" onchange="toggleGroupSelectAll(this)">
                                                </th>
                                                <th>System Name</th>
                                                <th>RSCM IP</th>
                                                <th>Port</th>
                                                <th>Checks</th>
                                                <th>Last Check</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${uSystems.map(s => generateCompactTableRow(s)).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                locationHtml += `
                        </div>
                    </div>
                `;
            });
            
            locationHtml += `
                        </div>
                    </div>
                `;
            });
            
            locationHtml += `
                    </div>
                </div>
            `;
        });
        
        locationHtml += `
                    </div>
                </div>
            </div>
        `;
        
        container.insertAdjacentHTML('beforeend', locationHtml);
    });
}

// Render grouped systems
function renderGrouped(systems, groupBy) {
    const container = document.getElementById('systemsContainer');
    container.innerHTML = '';
    
    if (groupBy === 'tree') {
        // Special rendering for hierarchical tree view
        renderTreeView(systems);
        return;
    }
    
    if (groupBy === 'rack') {
        // Special rendering for rack view with U-height grouping
        renderRackView(systems);
        return;
    }
    
    // Group systems
    const groups = {};
    systems.forEach(system => {
        const metadata = parseMetadata(system.description);
        let groupKey;
        
        switch(groupBy) {
            case 'location':
                groupKey = metadata.location || 'No Location';
                break;
            case 'building':
                groupKey = metadata.building || 'No Building';
                break;
            default:
                groupKey = 'All Systems';
        }
        
        if (!groups[groupKey]) {
            groups[groupKey] = [];
        }
        groups[groupKey].push(system);
    });
    
    // Sort group keys
    const sortedGroups = Object.keys(groups).sort((a, b) => {
        // Put "No X" groups at the end
        if (a.startsWith('No ')) return 1;
        if (b.startsWith('No ')) return -1;
        return a.localeCompare(b);
    });
    
    // Render each group
    sortedGroups.forEach(groupKey => {
        const groupSystems = groups[groupKey];
        const groupHtml = `
            <div class="card mb-3">
                <div class="card-header bg-light">
                    <h5 class="mb-0">
                        <i class="bi bi-folder"></i> ${groupKey}
                        <span class="badge bg-primary ms-2">${groupSystems.length}</span>
                    </h5>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" class="group-select-all" onchange="toggleGroupSelectAll(this)">
                                    </th>
                                    <th>System Name</th>
                                    <th>RSCM IP</th>
                                    <th>Port</th>
                                    <th>Location</th>
                                    <th>Checks</th>
                                    <th>Last Check</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${groupSystems.map(s => generateTableRow(s)).join('')}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        `;
        container.insertAdjacentHTML('beforeend', groupHtml);
    });
}

// Save filter preferences to localStorage
function saveFilterPreferences() {
    try {
        const preferences = {
            searchTerm: document.getElementById('searchInput').value,
            groupBy: document.getElementById('groupByFilter').value,
            sortBy: document.getElementById('sortByFilter').value,
            createdBy: document.getElementById('createdByFilter').value
        };
        localStorage.setItem('systemsFilterPreferences', JSON.stringify(preferences));
    } catch (e) {
        // Silently fail if localStorage is blocked by tracking prevention
        console.log('Cannot save preferences: localStorage blocked');
    }
}

// Load filter preferences from localStorage
function loadFilterPreferences() {
    try {
        const saved = localStorage.getItem('systemsFilterPreferences');
        if (saved) {
            const preferences = JSON.parse(saved);
            document.getElementById('searchInput').value = preferences.searchTerm || '';
            document.getElementById('groupByFilter').value = preferences.groupBy || 'tree';
            document.getElementById('sortByFilter').value = preferences.sortBy || 'name-asc';
            document.getElementById('createdByFilter').value = preferences.createdBy || 'all';
        }
    } catch (e) {
        // Silently fail if localStorage is blocked by tracking prevention
        console.log('Cannot load preferences: localStorage blocked');
    }
}

// Filter and sort systems
function filterAndSortSystems() {
    const searchTerm = document.getElementById('searchInput').value.toLowerCase();
    const groupBy = document.getElementById('groupByFilter').value;
    const sortBy = document.getElementById('sortByFilter').value;
    const createdBy = document.getElementById('createdByFilter').value;
    
    // Save preferences
    saveFilterPreferences();
    
    // Filter systems
    let filtered = systemsData.filter(system => {
        const metadata = parseMetadata(system.description);
        const searchableText = [
            system.name,
            system.rscm_ip,
            system.description,
            metadata.hostname,
            metadata.location,
            metadata.building,
            metadata.room,
            metadata.rack
        ].join(' ').toLowerCase();
        
        // Check search term
        if (!searchableText.includes(searchTerm)) {
            return false;
        }
        
        // Check creator filter
        if (createdBy === 'me') {
            // Show only systems created by current user
            const currentUserId = {{ session.get('user_id') or 'null' }};
            if (system.created_by !== currentUserId) {
                return false;
            }
        } else if (createdBy !== 'all') {
            // Show systems created by specific user
            if (system.created_by !== parseInt(createdBy)) {
                return false;
            }
        }
        
        return true;
    });
    
    // Sort systems
    filtered.sort((a, b) => {
        switch(sortBy) {
            case 'name-asc':
                return a.name.localeCompare(b.name);
            case 'name-desc':
                return b.name.localeCompare(a.name);
            case 'checks-desc':
                return b.check_count - a.check_count;
            case 'checks-asc':
                return a.check_count - b.check_count;
            case 'recent':
                const aTime = a.last_check || '0';
                const bTime = b.last_check || '0';
                return bTime.localeCompare(aTime);
            default:
                return 0;
        }
    });
    
    // Update visible count
    document.getElementById('visibleCount').textContent = filtered.length;
    
    // Show/hide no results message
    const noResults = document.getElementById('noResultsMessage');
    if (filtered.length === 0) {
        document.getElementById('systemsContainer').style.display = 'none';
        noResults.style.display = 'block';
    } else {
        document.getElementById('systemsContainer').style.display = 'block';
        noResults.style.display = 'none';
        
        // Render based on grouping
        if (groupBy === 'none') {
            renderUngrouped(filtered);
        } else {
            renderGrouped(filtered, groupBy);
        }
    }
}

// Clear filters
function clearFilters() {
    document.getElementById('searchInput').value = '';
    document.getElementById('groupByFilter').value = 'none';
    document.getElementById('sortByFilter').value = 'name-asc';
    document.getElementById('createdByFilter').value = 'all';
    saveFilterPreferences(); // Save cleared state
    filterAndSortSystems();
}

// Event listeners
document.getElementById('searchInput').addEventListener('input', filterAndSortSystems);
document.getElementById('groupByFilter').addEventListener('change', filterAndSortSystems);
document.getElementById('sortByFilter').addEventListener('change', filterAndSortSystems);
document.getElementById('createdByFilter').addEventListener('change', filterAndSortSystems);

// Load preferences and initial render
loadFilterPreferences();
filterAndSortSystems();

// Set up delete modal when it's about to be shown
document.getElementById('deleteModal').addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    const systemName = button.getAttribute('data-system-name');
    const systemId = button.getAttribute('data-system-id');
    
    // Update modal content
    document.getElementById('deleteSystemName').textContent = systemName;
    document.getElementById('deleteForm').action = `${SCRIPT_ROOT}/systems/${systemId}/delete`;
});

// Bulk check functionality
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.system-checkbox:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = count;
    document.getElementById('bulkCheckBtn').style.display = count > 0 ? 'inline-block' : 'none';
    
    // Update select all checkbox state
    const allCheckboxes = document.querySelectorAll('.system-checkbox');
    const selectAllCheckbox = document.getElementById('selectAllCheckbox');
    if (selectAllCheckbox) {
        selectAllCheckbox.checked = count === allCheckboxes.length && count > 0;
        selectAllCheckbox.indeterminate = count > 0 && count < allCheckboxes.length;
    }
}

function toggleSelectAll(checkbox) {
    const checkboxes = document.querySelectorAll('.system-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelectedCount();
}

function toggleGroupSelectAll(checkbox) {
    // Find all checkboxes in the same table
    const table = checkbox.closest('table');
    const checkboxes = table.querySelectorAll('.system-checkbox');
    checkboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
    updateSelectedCount();
}

function startBulkCheck() {
    const checkboxes = document.querySelectorAll('.system-checkbox:checked');
    const systemIds = Array.from(checkboxes).map(cb => cb.value);
    
    if (systemIds.length === 0) {
        alert('Please select at least one system');
        return;
    }
    
    // Redirect to bulk check page with selected system IDs
    window.location.href = `${SCRIPT_ROOT}/bulk-check?systems=${systemIds.join(',')}`;
}

// Add event listeners for collapse animations
document.addEventListener('DOMContentLoaded', function() {
    // Handle all collapse events to rotate chevron icons and save state
    document.querySelectorAll('.collapse').forEach(collapseEl => {
        collapseEl.addEventListener('show.bs.collapse', function () {
            const targetId = this.id;
            const icon = document.getElementById('icon-' + targetId);
            if (icon) {
                icon.classList.remove('bi-chevron-right');
                icon.classList.add('bi-chevron-down');
            }
            // Save expanded state
            saveCollapseState(targetId, true);
        });
        
        collapseEl.addEventListener('hide.bs.collapse', function () {
            const targetId = this.id;
            const icon = document.getElementById('icon-' + targetId);
            if (icon) {
                icon.classList.remove('bi-chevron-down');
                icon.classList.add('bi-chevron-right');
            }
            // Save collapsed state
            saveCollapseState(targetId, false);
        });
    });
    
    // Restore collapse states after tree is rendered
    restoreCollapseStates();
});

// Save collapse state to localStorage
function saveCollapseState(collapseId, isExpanded) {
    try {
        let collapseStates = JSON.parse(localStorage.getItem('treeCollapseStates') || '{}');
        collapseStates[collapseId] = isExpanded;
        localStorage.setItem('treeCollapseStates', JSON.stringify(collapseStates));
    } catch (e) {
        console.log('Cannot save collapse state: localStorage blocked');
    }
}

// Restore collapse states from localStorage
function restoreCollapseStates() {
    try {
        const collapseStates = JSON.parse(localStorage.getItem('treeCollapseStates') || '{}');
        
        // Apply saved states
        Object.keys(collapseStates).forEach(collapseId => {
            const collapseEl = document.getElementById(collapseId);
            if (collapseEl && collapseStates[collapseId]) {
                // Expand this section
                collapseEl.classList.add('show');
                
                // Update chevron icon
                const icon = document.getElementById('icon-' + collapseId);
                if (icon) {
                    icon.classList.remove('bi-chevron-right');
                    icon.classList.add('bi-chevron-down');
                }
            }
        });
    } catch (e) {
        console.log('Cannot restore collapse state: localStorage blocked');
    }
}
</script>
{% endblock %}