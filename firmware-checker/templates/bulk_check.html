{% extends "base.html" %}

{% block title %}Bulk Firmware Check - Firmware Version Checker{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-check-circle-fill"></i> Bulk Firmware Check</h1>
                <p class="lead">Configure firmware check for {{ systems|length }} systems</p>
            </div>
            <div>
                <a href="{{ url_for('systems') }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to Systems
                </a>
            </div>
        </div>
    </div>
</div>

<!-- Firmware Check Configuration Form -->
<div class="row" id="configurationSection">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> Firmware Check Configuration</h5>
            </div>
            <div class="card-body">
                <!-- Selected Systems -->
                <div class="row mb-4">
                    <div class="col-12">
                        <h6><i class="bi bi-server"></i> Selected Systems ({{ systems|length }})</h6>
                        <div class="table-responsive">
                            <table class="table table-sm table-hover">
                                <thead>
                                    <tr>
                                        <th>System Name</th>
                                        <th>RSCM IP</th>
                                        <th>Port</th>
                                        <th>Hostname/IP for Storage Checks</th>
                                    </tr>
                                </thead>
                                <tbody id="systemsTableBody">
                                    {% for system in systems %}
                                    <tr>
                                        <td><strong>{{ system.name }}</strong></td>
                                        <td><code>{{ system.rscm_ip }}</code></td>
                                        <td><span class="badge bg-secondary">{{ system.rscm_port }}</span></td>
                                        <td>
                                            <input type="text" 
                                                   class="form-control form-control-sm target-hostname" 
                                                   id="target_{{ system.id }}"
                                                   data-system-id="{{ system.id }}"
                                                   value="{{ system.target_hostname }}"
                                                   placeholder="Optional: hostname/IP for WinRM">
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i>
                            <strong>Storage Checks:</strong> Target hostname/IP is only needed if you provide Windows OS credentials below. 
                            Each system can connect to a different target for storage firmware checks.
                        </div>
                    </div>
                </div>

                <!-- Credentials Section -->
                <div class="row mb-4">
                    <!-- RSCM/Redfish Credentials -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6><i class="bi bi-key"></i> RSCM Authentication Credentials</h6>
                                <p class="text-muted small">Enter the same credentials used for Redfish API access. These will be used for all selected systems.</p>
                                <div class="mb-3">
                                    <label for="rscm_username" class="form-label">Username <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="rscm_username" 
                                           placeholder="Enter RSCM username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="rscm_password" class="form-label">Password <span class="text-danger">*</span></label>
                                    <input type="password" class="form-control" id="rscm_password" 
                                           placeholder="Enter RSCM password" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Windows OS Credentials -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6><i class="bi bi-pc-display"></i> Windows OS Credentials <span class="badge bg-secondary">Optional</span></h6>
                                <p class="text-muted small">Required for M.2 and E.1s storage firmware checks via WinRM. Leave blank to skip in-band storage checks.</p>
                                <div class="mb-3">
                                    <label for="windows_username" class="form-label">OS Username</label>
                                    <input type="text" class="form-control" id="windows_username" 
                                           placeholder="Windows OS username">
                                </div>
                                <div class="mb-3">
                                    <label for="windows_password" class="form-label">OS Password</label>
                                    <input type="password" class="form-control" id="windows_password" 
                                           placeholder="Windows OS password">
                                </div>
                                <div class="alert alert-warning small">
                                    <i class="bi bi-exclamation-triangle"></i>
                                    If OS credentials are provided, you must specify target hostname/IP for each system in the table above.
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Selective Firmware Check Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="bi bi-toggles"></i> Select Firmware Types to Check <span class="badge bg-info">Advanced</span></h6>
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#selectiveFirmwareCollapse">
                                        <i class="bi bi-chevron-down"></i> Show Options
                                    </button>
                                </div>
                                <div class="collapse" id="selectiveFirmwareCollapse">
                                    <p class="text-muted small mb-3">By default, all firmware types are checked. Uncheck specific types below to skip them (useful for debugging or quick rechecks).</p>
                                    
                                    <!-- Quick Selection Buttons -->
                                    <div class="btn-group mb-3" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllFirmware()">
                                            <i class="bi bi-check-all"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllFirmware()">
                                            <i class="bi bi-x"></i> Deselect All
                                        </button>
                                        {% for category in firmware_by_category.keys() %}
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="selectCategory('{{ category.lower().replace('-', '_').replace(' ', '_') }}')">
                                            {{ category }} Only
                                        </button>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Firmware Type Selection - Dynamic based on program -->
                                    <div class="row">
                                        {% if firmware_by_category and firmware_by_category|length > 0 %}
                                            {% for category, firmware_types in firmware_by_category.items() %}
                                            <div class="col-md-4 mb-3">
                                                <h6 class="text-primary">{{ category }} ({{ firmware_types|length }} types)</h6>
                                                {% for fw_type in firmware_types %}
                                                <div class="form-check">
                                                    <input class="form-check-input fw-category {{ category.lower().replace('-', '_').replace(' ', '_') }}" 
                                                           type="checkbox" 
                                                           value="{{ fw_type['name'] }}" 
                                                           id="fw_{{ fw_type['id'] }}" 
                                                           checked>
                                                    <label class="form-check-label small" for="fw_{{ fw_type['id'] }}">
                                                        {{ fw_type['name'] }}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                        <div class="col-12">
                                            <div class="alert alert-warning">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                No firmware types configured for this program. Please contact an administrator to assign firmware types to this program.
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <div class="mt-2">
                                        <small class="text-muted">
                                            <span id="selectedCount">All firmware types</span> selected
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Start Check Button -->
                <div class="d-grid">
                    <button type="button" class="btn btn-success btn-lg" onclick="startBulkCheck()">
                        <i class="bi bi-play-fill"></i> Start Firmware Check on {{ systems|length }} Systems
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Progress Section (hidden until checks start) -->
<div id="progressSection" style="display: none;">

<!-- Overall Progress -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <h5 class="mb-3">Overall Progress</h5>
                <div class="progress" style="height: 30px;">
                    <div id="overallProgress" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%">
                        <span id="progressText">0 / {{ systems|length }} complete</span>
                    </div>
                </div>
                <div class="mt-3 text-center">
                    <span class="badge bg-success me-2">
                        <i class="bi bi-check-circle"></i> <span id="successCount">0</span> Completed
                    </span>
                    <span class="badge bg-warning me-2">
                        <i class="bi bi-clock"></i> <span id="runningCount">{{ systems|length }}</span> Running
                    </span>
                    <span class="badge bg-danger">
                        <i class="bi bi-x-circle"></i> <span id="failedCount">0</span> Failed
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Individual System Checks -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-list-check"></i> System Check Status</h5>
            </div>
            <div class="card-body">
                <div id="checkStatusContainer">
                    {% for system in systems %}
                    <div class="check-item mb-3 pb-3 border-bottom" id="check-{{ system.id }}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <span class="status-icon" id="status-icon-{{ system.id }}">
                                        <i class="bi bi-clock text-warning"></i>
                                    </span>
                                    {{ system.name }}
                                </h6>
                                <small class="text-muted">{{ system.rscm_ip }}:{{ system.rscm_port }}</small>
                                <div class="mt-2">
                                    <span class="badge bg-secondary" id="badge-{{ system.id }}">Queued</span>
                                    <span class="text-muted small ms-2" id="message-{{ system.id }}">Waiting to start...</span>
                                </div>
                            </div>
                            <div>
                                <a href="#" class="btn btn-sm btn-outline-primary view-result-btn" 
                                   id="view-btn-{{ system.id }}" style="display: none;">
                                    <i class="bi bi-eye"></i> View Result
                                </a>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Summary Section (hidden until all checks complete) -->
<div id="summarySection" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card border-success">
            <div class="card-header bg-success text-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clipboard-check"></i> Bulk Check Results Summary</h5>
                <div>
                    <select id="recipeSelector" class="form-select form-select-sm d-inline-block" style="width: auto; background-color: white; color: #212529;">
                        <option value="">Compare with Recipe...</option>
                        <!-- Populated by JavaScript -->
                    </select>
                    <button class="btn btn-sm btn-light ms-2" onclick="compareWithRecipe()">
                        <i class="bi bi-bar-chart"></i> Compare
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="summaryTableContainer">
                    <!-- Summary rows will be added here -->
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_scripts %}
<script>
const SCRIPT_ROOT = {{ request.script_root|tojson }};
const systemIds = {{ system_ids|tojson }};
const checkIds = new Map(); // Map system_id to check_id
let completedCount = 0;
let failedCount = 0;
const totalCount = systemIds.length;
let credentials = null;

// Firmware Selection Functions
function updateSelectedCount() {
    const checkboxes = document.querySelectorAll('.fw-category:checked');
    const count = checkboxes.length;
    document.getElementById('selectedCount').textContent = `${count} firmware type${count !== 1 ? 's' : ''}`;
}

function selectAllFirmware() {
    document.querySelectorAll('.fw-category').forEach(cb => {
        cb.checked = true;
    });
    updateSelectedCount();
}

function deselectAllFirmware() {
    document.querySelectorAll('.fw-category').forEach(cb => {
        cb.checked = false;
    });
    updateSelectedCount();
}

function selectCategory(category) {
    // Deselect all checkboxes first
    document.querySelectorAll('.fw-category').forEach(cb => {
        cb.checked = false;
    });
    // Select only the specified category
    document.querySelectorAll(`.fw-category.${category}`).forEach(cb => {
        cb.checked = true;
    });
    updateSelectedCount();
}

function getSelectedFirmwareTypes() {
    const selected = {
        dc_scm: [],
        ovl2: [],
        other_platform: []
    };
    
    document.querySelectorAll('.fw-category:checked').forEach(cb => {
        const category = Array.from(cb.classList).find(c => ['dc_scm', 'ovl2', 'other_platform'].includes(c));
        if (category) {
            selected[category].push(cb.value);
        }
    });
    
    return selected;
}

// Add event listeners to update count when checkboxes change
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.fw-category').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
    updateSelectedCount();
});

// Start bulk check
function startBulkCheck() {
    // Get RSCM credentials
    const rscmUsername = document.getElementById('rscm_username').value.trim();
    const rscmPassword = document.getElementById('rscm_password').value.trim();
    
    if (!rscmUsername || !rscmPassword) {
        alert('RSCM username and password are required.');
        return;
    }
    
    // Get optional Windows credentials
    const winUsername = document.getElementById('windows_username').value.trim();
    const winPassword = document.getElementById('windows_password').value.trim();
    
    // Validate Windows credentials - if any are provided, both must be provided
    if ((winUsername && !winPassword) || (!winUsername && winPassword)) {
        alert('If providing Windows credentials, both username and password must be filled in.');
        return;
    }
    
    // If Windows credentials provided, check that at least one system has a target hostname
    if (winUsername && winPassword) {
        const targetInputs = document.querySelectorAll('.target-hostname');
        const hasAnyTarget = Array.from(targetInputs).some(input => input.value.trim());
        
        if (!hasAnyTarget) {
            alert('Windows credentials provided but no target hostnames specified. Please specify at least one target hostname/IP for storage checks, or leave Windows credentials blank.');
            return;
        }
    }
    
    // Store base credentials
    credentials = {
        rscm_username: rscmUsername,
        rscm_password: rscmPassword
    };
    
    if (winUsername) {
        credentials.windows_username = winUsername;
        credentials.windows_password = winPassword;
    }
    
    // Hide configuration and show progress
    document.getElementById('configurationSection').style.display = 'none';
    document.getElementById('progressSection').style.display = 'block';
    
    // Start all checks
    startAllChecks();
}

// Start all checks
async function startAllChecks() {
    // Start checks sequentially with a 2-second delay between each
    // This prevents overwhelming the RSCM SSH servers with too many concurrent connections
    for (let i = 0; i < systemIds.length; i++) {
        const systemId = systemIds[i];
        await startCheck(systemId);
        
        // Add delay before starting next system (except after the last one)
        if (i < systemIds.length - 1) {
            await new Promise(resolve => setTimeout(resolve, 2000));
        }
    }
}

// Start individual check
async function startCheck(systemId) {
    try {
        // Update UI: Starting
        updateCheckStatus(systemId, 'running', 'Running', 'Starting firmware check...', 'bg-warning');
        
        // Get selected firmware types
        const selectedFirmware = getSelectedFirmwareTypes();
        
        // Prepare request payload with credentials
        const payload = {
            system_id: systemId,
            username: credentials.rscm_username,
            password: credentials.rscm_password,
            bulk: true,
            selected_firmware: selectedFirmware
        };
        
        // Add Windows credentials and per-system target hostname if provided
        if (credentials.windows_username) {
            const targetInput = document.getElementById(`target_${systemId}`);
            const targetHostname = targetInput ? targetInput.value.trim() : '';
            
            // Only add Windows credentials if this system has a target hostname
            if (targetHostname) {
                payload.os_username = credentials.windows_username;
                payload.os_password = credentials.windows_password;
                payload.computer_name = targetHostname;
            }
        }
        
        // Initiate check via API
        const response = await fetch(`${SCRIPT_ROOT}/api/check-firmware`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(payload)
        });
        
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.error || `HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        const checkId = data.check_id;
        checkIds.set(systemId, checkId);
        
        // Poll for results
        pollCheckStatus(systemId, checkId);
        
    } catch (error) {
        console.error(`Error starting check for system ${systemId}:`, error);
        updateCheckStatus(systemId, 'failed', 'Failed', error.message, 'bg-danger');
        incrementFailed();
    }
}

// Poll check status
async function pollCheckStatus(systemId, checkId) {
    const maxAttempts = 120; // 10 minutes max (5 second intervals)
    let attempts = 0;
    
    const pollInterval = setInterval(async () => {
        attempts++;
        
        try {
            // Use the existing system status endpoint
            const response = await fetch(`${SCRIPT_ROOT}/api/check-status/${systemId}`);
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            // Check status
            if (data.status === 'completed' || data.status === 'success') {
                clearInterval(pollInterval);
                
                // Mark as 100% complete
                checkIds.set(systemId + '_progress', 100);
                
                updateCheckStatus(systemId, 'success', 'Completed', 
                    `Check completed successfully`, 'bg-success', 100);
                
                // Enable view button
                const viewBtn = document.getElementById(`view-btn-${systemId}`);
                viewBtn.href = `${SCRIPT_ROOT}/check/result/${data.check_id}`;
                viewBtn.style.display = 'inline-block';
                
                incrementCompleted();
            } else if (data.status === 'error') {
                clearInterval(pollInterval);
                
                // Mark as 100% (failed but complete)
                checkIds.set(systemId + '_progress', 100);
                
                updateCheckStatus(systemId, 'failed', 'Failed', 
                    data.error || 'Check failed', 'bg-danger', 100);
                incrementFailed();
            } else if (data.status === 'running') {
                const runtime = data.thread_info ? Math.floor(data.thread_info.runtime_seconds) : 0;
                const currentCategory = data.thread_info ? data.thread_info.current_category : 'unknown';
                
                // Try to get actual progress from progress_data
                let progressPercent = 0;
                if (data.progress_data && data.progress_data.progress && data.progress_data.progress.percentage !== undefined) {
                    progressPercent = data.progress_data.progress.percentage;
                }
                
                updateCheckStatus(systemId, 'running', 'Running', 
                    `${currentCategory} - ${progressPercent}% (${runtime}s)`, 'bg-warning', progressPercent);
            } else if (data.status === 'none') {
                // No check found yet, keep waiting
                updateCheckStatus(systemId, 'running', 'Starting', 
                    'Initializing check...', 'bg-warning', 0);
            }
            
            if (attempts >= maxAttempts) {
                clearInterval(pollInterval);
                updateCheckStatus(systemId, 'failed', 'Timeout', 
                    'Check timed out after 10 minutes', 'bg-danger');
                incrementFailed();
            }
        } catch (error) {
            console.error(`Error polling status for system ${systemId}:`, error);
            clearInterval(pollInterval);
            updateCheckStatus(systemId, 'failed', 'Error', 
                'Failed to get check status', 'bg-danger');
            incrementFailed();
        }
    }, 5000); // Poll every 5 seconds
}

// Update check status UI
function updateCheckStatus(systemId, status, badgeText, message, badgeClass, progressPercent = null) {
    const statusIcon = document.getElementById(`status-icon-${systemId}`);
    const badge = document.getElementById(`badge-${systemId}`);
    const messageEl = document.getElementById(`message-${systemId}`);
    
    // Update icon
    let iconHtml = '';
    if (status === 'success') {
        iconHtml = '<i class="bi bi-check-circle-fill text-success"></i>';
    } else if (status === 'failed') {
        iconHtml = '<i class="bi bi-x-circle-fill text-danger"></i>';
    } else if (status === 'running') {
        iconHtml = '<i class="bi bi-clock text-warning"></i>';
    }
    statusIcon.innerHTML = iconHtml;
    
    // Update badge
    badge.className = `badge ${badgeClass}`;
    badge.textContent = badgeText;
    
    // Update message
    messageEl.textContent = message;
    
    // Store progress for this system
    if (progressPercent !== null) {
        checkIds.set(systemId + '_progress', progressPercent);
    }
    
    // Update overall progress
    updateOverallProgress();
}

// Increment counters
function incrementCompleted() {
    completedCount++;
    document.getElementById('successCount').textContent = completedCount;
    document.getElementById('runningCount').textContent = totalCount - completedCount - failedCount;
    updateOverallProgress();
}

function incrementFailed() {
    failedCount++;
    document.getElementById('failedCount').textContent = failedCount;
    document.getElementById('runningCount').textContent = totalCount - completedCount - failedCount;
    updateOverallProgress();
}

function updateOverallProgress() {
    // Calculate overall progress based on individual system progress
    let totalProgress = 0;
    
    for (let i = 0; i < systemIds.length; i++) {
        const systemId = systemIds[i];
        const systemProgress = checkIds.get(systemId + '_progress');
        
        if (systemProgress !== undefined) {
            totalProgress += systemProgress;
        } else {
            // If completed or failed, count as 100%
            if (completedCount > 0 || failedCount > 0) {
                // Check if this specific system is completed/failed by checking if it has a check_id
                const hasCheckId = checkIds.has(systemId);
                if (hasCheckId) {
                    totalProgress += 100;
                }
            }
        }
    }
    
    const progress = totalCount > 0 ? (totalProgress / totalCount) : 0;
    const progressBar = document.getElementById('overallProgress');
    const progressText = document.getElementById('progressText');
    
    progressBar.style.width = progress + '%';
    progressBar.setAttribute('aria-valuenow', progress);
    
    // Show detailed progress text
    const runningCount = totalCount - completedCount - failedCount;
    progressText.textContent = `${Math.round(progress)}% - ${completedCount} complete, ${runningCount} running, ${failedCount} failed`;
    
    // Change color based on status
    if (completedCount + failedCount === totalCount) {
        progressBar.classList.remove('progress-bar-animated');
        if (failedCount === 0) {
            progressBar.classList.add('bg-success');
        } else if (completedCount === 0) {
            progressBar.classList.add('bg-danger');
        } else {
            progressBar.classList.add('bg-warning');
        }
        
        // Show summary when all checks complete
        showSummary();
    }
}

// Show results summary table
async function showSummary() {
    const summarySection = document.getElementById('summarySection');
    const container = document.getElementById('summaryTableContainer');
    
    // Load available recipes
    await loadRecipes();
    
    // Clear existing content
    container.innerHTML = '';
    
    // Fetch data for each system
    for (let i = 0; i < systemIds.length; i++) {
        const systemId = systemIds[i];
        const checkId = checkIds.get(systemId);
        
        if (!checkId) {
            continue; // Skip systems without check IDs
        }
        
        try {
            // Fetch check result data
            const response = await fetch(`${SCRIPT_ROOT}/api/check/${checkId}/firmware-data`);
            const data = await response.json();
            
            // Get system name and RSCM info from the page
            const systemNameElement = document.querySelector(`#check-${systemId} h6`);
            const systemName = systemNameElement ? systemNameElement.textContent.trim() : `System ${systemId}`;
            const rscmInfoElement = document.querySelector(`#check-${systemId} small`);
            const rscmInfo = rscmInfoElement ? rscmInfoElement.textContent : '';
            
            // Count results by status
            let successCount = 0;
            let errorCount = 0;
            let notImplementedCount = 0;
            let totalCount = 0;
            
            ['dc_scm', 'ovl2', 'other_platform'].forEach(category => {
                if (data[category]) {
                    Object.values(data[category]).forEach(fw => {
                        totalCount++;
                        if (fw.status === 'success') successCount++;
                        else if (fw.status === 'error') errorCount++;
                        else if (fw.status === 'not_implemented') notImplementedCount++;
                    });
                }
            });
            
            // Determine overall status
            let statusBadge = 'success';
            let statusText = 'Completed';
            if (errorCount > 0 && successCount === 0) {
                statusBadge = 'danger';
                statusText = 'Failed';
            } else if (errorCount > 0) {
                statusBadge = 'warning';
                statusText = 'Partial';
            }
            
            // Create collapsible summary card
            const summaryCard = document.createElement('div');
            summaryCard.className = 'card mb-2';
            summaryCard.setAttribute('data-check-id', checkId);
            summaryCard.setAttribute('data-system-id', systemId);
            
            summaryCard.innerHTML = `
                <div class="card-header bg-light">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <button class="btn btn-link text-start text-decoration-none p-0 w-100" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#firmware-${checkId}">
                                <i class="bi bi-chevron-right" id="chevron-${checkId}"></i>
                                <strong>${systemName}</strong>
                                <br>
                                <small class="text-muted"><code>${rscmInfo}</code></small>
                            </button>
                        </div>
                        <div class="col-md-2 text-center">
                            <span class="badge bg-${statusBadge}">${statusText}</span>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex justify-content-center gap-2">
                                <span class="badge bg-success">${successCount} Success</span>
                                <span class="badge bg-danger">${errorCount} Errors</span>
                                <span class="badge bg-secondary">${notImplementedCount} N/A</span>
                            </div>
                        </div>
                        <div class="col-md-2 text-end">
                            <a href="${SCRIPT_ROOT}/check/result/${checkId}" class="btn btn-sm btn-primary" target="_blank">
                                <i class="bi bi-eye"></i> Details
                            </a>
                        </div>
                    </div>
                </div>
                <div class="collapse" id="firmware-${checkId}">
                    <div class="card-body">
                        <div id="firmware-content-${checkId}">
                            ${generateFirmwareTable(data, checkId)}
                        </div>
                    </div>
                </div>
            `;
            
            container.appendChild(summaryCard);
            
            // Add event listener to toggle chevron
            const collapseElement = document.getElementById(`firmware-${checkId}`);
            const chevron = document.getElementById(`chevron-${checkId}`);
            collapseElement.addEventListener('show.bs.collapse', function () {
                chevron.classList.remove('bi-chevron-right');
                chevron.classList.add('bi-chevron-down');
            });
            collapseElement.addEventListener('hide.bs.collapse', function () {
                chevron.classList.remove('bi-chevron-down');
                chevron.classList.add('bi-chevron-right');
            });
            
        } catch (error) {
            console.error(`Error fetching summary for system ${systemId}:`, error);
        }
    }
    
    // Show the summary section
    summarySection.style.display = 'block';
    
    // Scroll to summary
    summarySection.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Generate firmware table for a system
function generateFirmwareTable(data, checkId) {
    let html = '<div class="accordion" id="accordion-' + checkId + '">';
    
    // Define category display names and order
    const categories = [
        { key: 'dc_scm', name: 'DC-SCM Firmware', icon: 'bi-cpu', color: 'primary' },
        { key: 'ovl2', name: 'OVL2 Firmware', icon: 'bi-hdd-rack', color: 'success' },
        { key: 'other_platform', name: 'Other Platform Firmware', icon: 'bi-device-hdd', color: 'info' }
    ];
    
    let categoryIndex = 0;
    
    categories.forEach(category => {
        if (data[category.key] && Object.keys(data[category.key]).length > 0) {
            categoryIndex++;
            
            // Count firmware by status
            let successCount = 0;
            let errorCount = 0;
            let notImplementedCount = 0;
            let totalCount = 0;
            
            Object.values(data[category.key]).forEach(fw => {
                totalCount++;
                if (fw.status === 'success') successCount++;
                else if (fw.status === 'error') errorCount++;
                else if (fw.status === 'not_implemented') notImplementedCount++;
            });
            
            html += `
                <div class="accordion-item">
                    <h2 class="accordion-header">
                        <button class="accordion-button ${categoryIndex > 1 ? 'collapsed' : ''}" type="button" 
                                data-bs-toggle="collapse" data-bs-target="#category-${checkId}-${category.key}">
                            <i class="${category.icon} me-2 text-${category.color}"></i> ${category.name}
                            <span class="ms-2">
                                <span class="badge bg-success">${successCount} Success</span>
                                ${errorCount > 0 ? `<span class="badge bg-danger">${errorCount} Errors</span>` : ''}
                                ${notImplementedCount > 0 ? `<span class="badge bg-secondary">${notImplementedCount} N/A</span>` : ''}
                            </span>
                        </button>
                    </h2>
                    <div id="category-${checkId}-${category.key}" 
                         class="accordion-collapse collapse ${categoryIndex === 1 ? 'show' : ''}" 
                         data-bs-parent="#accordion-${checkId}">
                        <div class="accordion-body p-0">
                            <div class="table-responsive">
                                <table class="table table-sm table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th style="width: 35%;">Firmware Type</th>
                                            <th style="width: 30%;">Version</th>
                                            <th style="width: 15%;" class="text-center">Status</th>
                                            <th style="width: 20%;">Notes</th>
                                        </tr>
                                    </thead>
                                    <tbody>
            `;
            
            // Sort firmware types alphabetically
            const sortedEntries = Object.entries(data[category.key]).sort((a, b) => a[0].localeCompare(b[0]));
            
            sortedEntries.forEach(([fwType, fwData]) => {
                let statusBadge, statusIcon, rowClass;
                
                if (fwData.status === 'success') {
                    statusBadge = 'success';
                    statusIcon = 'bi-check-circle-fill';
                    rowClass = '';
                } else if (fwData.status === 'error') {
                    statusBadge = 'danger';
                    statusIcon = 'bi-x-circle-fill';
                    rowClass = 'table-danger';
                } else if (fwData.status === 'not_implemented') {
                    statusBadge = 'secondary';
                    statusIcon = 'bi-dash-circle';
                    rowClass = '';
                } else if (fwData.status === 'not_found') {
                    statusBadge = 'warning';
                    statusIcon = 'bi-exclamation-triangle-fill';
                    rowClass = 'table-warning';
                } else {
                    statusBadge = 'secondary';
                    statusIcon = 'bi-question-circle';
                    rowClass = '';
                }
                
                const version = fwData.version || 'N/A';
                const error = fwData.error ? `<small class="text-danger">${escapeHtml(fwData.error)}</small>` : '';
                const note = fwData.note ? `<small class="text-muted">${escapeHtml(fwData.note)}</small>` : '';
                const notes = error || note || '-';
                
                html += `
                    <tr class="${rowClass}">
                        <td><strong>${escapeHtml(fwType)}</strong></td>
                        <td><code>${escapeHtml(version)}</code></td>
                        <td class="text-center">
                            <i class="bi ${statusIcon} text-${statusBadge}"></i>
                        </td>
                        <td>${notes}</td>
                    </tr>
                `;
            });
            
            html += `
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
    });
    
    html += '</div>';
    return html;
}

// Escape HTML to prevent XSS
function escapeHtml(text) {
    const map = {
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#039;'
    };
    return String(text).replace(/[&<>"']/g, m => map[m]);
}

// Load available recipes
async function loadRecipes() {
    try {
        const response = await fetch(`${SCRIPT_ROOT}/api/recipes`);
        const recipes = await response.json();
        
        const selector = document.getElementById('recipeSelector');
        selector.innerHTML = '<option value="">Compare with Recipe...</option>';
        
        recipes.forEach(recipe => {
            const option = document.createElement('option');
            option.value = recipe.id;
            option.textContent = recipe.name;
            selector.appendChild(option);
        });
    } catch (error) {
        console.error('Error loading recipes:', error);
    }
}

// Compare all checks with selected recipe
async function compareWithRecipe() {
    const recipeId = document.getElementById('recipeSelector').value;
    if (!recipeId) {
        alert('Please select a recipe to compare against');
        return;
    }
    
    // Loop through all systems and update their firmware tables with comparison results
    for (let i = 0; i < systemIds.length; i++) {
        const systemId = systemIds[i];
        const checkId = checkIds.get(systemId);
        
        if (!checkId) continue;
        
        try {
            // Fetch comparison data
            const response = await fetch(`${SCRIPT_ROOT}/api/check/${checkId}/compare-recipe/${recipeId}`);
            const comparisonData = await response.json();
            
            if (comparisonData.error) {
                console.error(`Error comparing check ${checkId}:`, comparisonData.error);
                continue;
            }
            
            // Update the firmware table with comparison results
            updateFirmwareTableWithComparison(checkId, comparisonData);
            
        } catch (error) {
            console.error(`Error comparing check ${checkId}:`, error);
        }
    }
}

// Update firmware table with recipe comparison
function updateFirmwareTableWithComparison(checkId, comparisonData) {
    const container = document.getElementById(`firmware-content-${checkId}`);
    if (!container) return;
    
    const comparison = comparisonData.comparison;
    
    // Find all version codes and add comparison badges
    const rows = container.querySelectorAll('tr');
    rows.forEach(row => {
        const fwTypeCell = row.querySelector('td:first-child strong');
        const versionCell = row.querySelector('td:nth-child(2)');
        const notesCell = row.querySelector('td:nth-child(4)');
        
        if (!fwTypeCell || !versionCell) return;
        
        const fwType = fwTypeCell.textContent;
        const version = versionCell.querySelector('code')?.textContent;
        
        // Check if this firmware is in the comparison results
        let comparisonBadge = '';
        let comparisonNote = '';
        
        ['dc_scm', 'ovl2', 'other_platform'].forEach(category => {
            if (comparison[category] && comparison[category][fwType]) {
                const comp = comparison[category][fwType];
                
                if (comp.match === 'exact') {
                    comparisonBadge = '<span class="badge bg-success ms-2" title="Matches recipe">✓ Match</span>';
                } else if (comp.match === 'mismatch') {
                    comparisonBadge = '<span class="badge bg-warning ms-2" title="Different from recipe">⚠ Mismatch</span>';
                    comparisonNote = `<br><small class="text-warning">Expected: <code>${comp.recipe_version}</code></small>`;
                } else if (comp.match === 'not_in_recipe') {
                    comparisonBadge = '<span class="badge bg-secondary ms-2" title="Not in recipe">- Not in Recipe</span>';
                }
            }
        });
        
        if (comparisonBadge) {
            versionCell.innerHTML += comparisonBadge;
        }
        if (comparisonNote && notesCell) {
            notesCell.innerHTML += comparisonNote;
        }
    });
    
    // Add summary comparison stats at the top
    const summaryDiv = document.createElement('div');
    summaryDiv.className = 'alert alert-info mb-3';
    summaryDiv.innerHTML = `
        <h6><i class="bi bi-bar-chart"></i> Recipe Comparison: ${comparisonData.recipe.name}</h6>
        <div class="d-flex gap-3">
            <span><i class="bi bi-check-circle-fill text-success"></i> ${comparison.summary.matches} Matches</span>
            <span><i class="bi bi-exclamation-triangle-fill text-warning"></i> ${comparison.summary.mismatches} Mismatches</span>
            <span><i class="bi bi-dash-circle text-secondary"></i> ${comparison.summary.not_in_recipe} Not in Recipe</span>
        </div>
    `;
    container.insertBefore(summaryDiv, container.firstChild);
}

// Don't auto-start - wait for form submission
</script>
{% endblock %}
