{% extends "base.html" %}

{% block title %}Check Firmware - {{ system.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h1><i class="bi bi-check-circle"></i> Check Firmware</h1>
                <p class="lead">System: <strong>{{ system.name }}</strong> ({{ system.rscm_ip }}:{{ system.rscm_port }})</p>
            </div>
            <div>
                <a href="{{ url_for('check_progress', system_id=system.id) }}" class="btn btn-info me-2">
                    <i class="bi bi-clock-history"></i> View Last Check
                </a>
                <a href="{{ url_for('system_detail', system_id=system.id) }}" class="btn btn-outline-secondary">
                    <i class="bi bi-arrow-left"></i> Back to System
                </a>
            </div>
        </div>
    </div>
</div>

{% if active_check %}
<!-- Active Check Progress Display -->
<div class="row">
    <div class="col-12">
        <div class="card border-warning">
            <div class="card-header bg-warning text-dark">
                <h5 class="mb-0">
                    <i class="bi bi-clock"></i>
                    Firmware Check in Progress - Started {{ active_check.check_date[:19] }}
                    <span class="badge bg-dark ms-2">Running</span>
                </h5>
            </div>
            <div class="card-body">
                <!-- Progress Animation -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card bg-light">
                            <div class="card-body text-center">
                                <div class="spinner-border text-primary mb-3" role="status">
                                    <span class="visually-hidden">Loading...</span>
                                </div>
                                <h5 class="text-primary">Firmware Check in Progress</h5>
                                <p class="text-muted mb-3">The firmware check is currently running. Real-time progress below:</p>
                                
                                <!-- Real-time Progress Bar -->
                                <div class="progress mb-3" style="height: 30px;">
                                    <div id="activeProgressBar" class="progress-bar progress-bar-striped progress-bar-animated bg-info" 
                                         role="progressbar" style="width: 5%">
                                        <span id="activeProgressText">Initializing...</span>
                                    </div>
                                </div>
                                
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>Estimated Time:</strong> Approximately 10 minutes for complete firmware check
                                </div>
                                
                                <button class="btn btn-primary" onclick="refreshActiveStatus({{ system.id }})">
                                    <i class="bi bi-arrow-clockwise"></i> Refresh Status
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Expected Process Steps -->
                <div class="row">
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-1-circle text-primary"></i> DC-SCM Firmware
                                </h6>
                                <ul class="list-unstyled small">
                                    <li><i class="bi bi-check-circle"></i> IFWI & BMC via Redfish API</li>
                                    <li><i class="bi bi-check-circle"></i> BMC configurations via SSH IPMI</li>
                                    <li><i class="bi bi-check-circle"></i> Security firmware via SSH Cerberus</li>
                                </ul>
                                <div class="text-muted small">16 firmware types</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-2-circle text-info"></i> OVL2 Firmware
                                </h6>
                                <ul class="list-unstyled small">
                                    <li><i class="bi bi-check-circle"></i> SOC Test OS via SSH serial</li>
                                    <li><i class="bi bi-check-circle"></i> FPGA drivers via SSH sessions</li>
                                    <li><i class="bi bi-check-circle"></i> Cyclone V & SOC FIP images</li>
                                </ul>
                                <div class="text-muted small">16 firmware types</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6 class="card-title">
                                    <i class="bi bi-3-circle text-warning"></i> Other Platform
                                </h6>
                                <ul class="list-unstyled small">
                                    <li><i class="bi bi-check-circle"></i> HPM CPLD via Redfish</li>
                                    <li><i class="bi bi-check-circle"></i> SOC VR configurations</li>
                                    <li><i class="bi bi-check-circle"></i> Storage device firmware</li>
                                </ul>
                                <div class="text-muted small">6 firmware types</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% else %}
<!-- Firmware Check Configuration Form -->
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-cpu"></i> Firmware Check Configuration</h5>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-6">
                        <h6><i class="bi bi-server"></i> System Information</h6>
                        <dl class="row">
                            <dt class="col-sm-4">Name:</dt>
                            <dd class="col-sm-8">{{ system.name }}</dd>
                            <dt class="col-sm-4">RSCM IP:</dt>
                            <dd class="col-sm-8"><code>{{ system.rscm_ip }}</code></dd>
                            <dt class="col-sm-4">Port:</dt>
                            <dd class="col-sm-8"><span class="badge bg-secondary">{{ system.rscm_port }}</span></dd>
                        </dl>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="bi bi-list-check"></i> Firmware Categories</h6>
                        <ul class="list-unstyled">
                            <li><i class="bi bi-check text-success"></i> DC-SCM (16 firmware types)</li>
                            <li><i class="bi bi-check text-success"></i> OVL2 (12 firmware types)</li>
                            <li><i class="bi bi-check text-success"></i> Other Platform (5 firmware types)</li>
                        </ul>
                        <p class="text-muted small">Total: 32 firmware types will be checked</p>
                    </div>
                </div>
                
                <!-- Credentials Section -->
                <div class="row mb-4">
                    <!-- RSCM/Redfish Credentials -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6><i class="bi bi-key"></i> Authentication Credentials</h6>
                                <p class="text-muted small">Enter the same credentials you use for Redfish API access</p>
                                <div class="mb-3">
                                    <label for="username" class="form-label">Username</label>
                                    <input type="text" class="form-control" id="username" placeholder="Enter username" required>
                                </div>
                                <div class="mb-3">
                                    <label for="password" class="form-label">Password</label>
                                    <input type="password" class="form-control" id="password" placeholder="Enter password" required>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Windows OS Credentials -->
                    <div class="col-md-6">
                        <div class="card h-100">
                            <div class="card-body">
                                <h6><i class="bi bi-pc-display"></i> Windows OS Credentials <span class="badge bg-secondary">Optional</span></h6>
                                <p class="text-muted small">Required for M.2, E.1s storage firmware, DIMM information, and Windows OS version checks via WinRM. Leave blank to skip in-band checks.</p>
                                <div class="mb-3">
                                    <label for="os_username" class="form-label">OS Username</label>
                                    <input type="text" class="form-control" id="os_username" placeholder="Windows OS username">
                                </div>
                                <div class="mb-3">
                                    <label for="os_password" class="form-label">OS Password</label>
                                    <input type="password" class="form-control" id="os_password" placeholder="Windows OS password">
                                </div>
                                <div class="mb-3">
                                    <label for="computer_name" class="form-label">Target Computer/IP</label>
                                    <input type="text" class="form-control" id="computer_name" 
                                           placeholder="Computer name or IP address"
                                           {% if system_hostname %}value="{{ system_hostname }}"{% endif %}>
                                    <div class="form-text">Specify target system for storage checks (required if OS credentials provided)</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Selective Firmware Check Section -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-info">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h6 class="mb-0"><i class="bi bi-toggles"></i> Select Firmware Types to Check <span class="badge bg-info">Advanced</span></h6>
                                    <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#selectiveFirmwareCollapse">
                                        <i class="bi bi-chevron-down"></i> Show Options
                                    </button>
                                </div>
                                <div class="collapse" id="selectiveFirmwareCollapse">
                                    <p class="text-muted small mb-3">By default, all firmware types are checked. Uncheck specific types below to skip them (useful for debugging or quick rechecks).</p>
                                    
                                    <!-- Quick Selection Buttons -->
                                    <div class="btn-group mb-3" role="group">
                                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="selectAllFirmware()">
                                            <i class="bi bi-check-all"></i> Select All
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="deselectAllFirmware()">
                                            <i class="bi bi-x"></i> Deselect All
                                        </button>
                                        {% for category in firmware_by_category.keys() %}
                                        <button type="button" class="btn btn-sm btn-outline-info" onclick="selectCategory('{{ category.lower().replace('-', '_').replace(' ', '_') }}')">
                                            {{ category }} Only
                                        </button>
                                        {% endfor %}
                                    </div>
                                    
                                    <!-- Firmware Type Selection - Dynamic based on program -->
                                    <div class="row">
                                        {% if firmware_by_category and firmware_by_category|length > 0 %}
                                            {% for category, firmware_types in firmware_by_category.items() %}
                                            <div class="col-md-4 mb-3">
                                                <h6 class="text-primary">{{ category }} ({{ firmware_types|length }} types)</h6>
                                                {% for fw_type in firmware_types %}
                                                <div class="form-check">
                                                    <input class="form-check-input fw-category {{ category.lower().replace('-', '_').replace(' ', '_') }}" 
                                                           type="checkbox" 
                                                           value="{{ fw_type['name'] }}" 
                                                           id="fw_{{ fw_type['id'] }}" 
                                                           checked>
                                                    <label class="form-check-label small" for="fw_{{ fw_type['id'] }}">
                                                        {{ fw_type['name'] }}
                                                    </label>
                                                </div>
                                                {% endfor %}
                                            </div>
                                            {% endfor %}
                                        {% else %}
                                        <div class="col-12">
                                            <div class="alert alert-warning">
                                                <i class="bi bi-exclamation-triangle"></i>
                                                No firmware types configured for this program. Please contact an administrator to assign firmware types to this program.
                                            </div>
                                        </div>
                                        {% endif %}
                                    </div>
                                    
                                    <!-- Keep the old hardcoded section for backwards compatibility (hidden) -->
                                    <div class="row d-none">
                                        <!-- DC-SCM -->
                                        <div class="col-md-4">
                                            <h6 class="text-primary">DC-SCM (16 types)</h6>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="IFWI" id="fw_ifwi_old" checked>
                                                <label class="form-check-label small" for="fw_ifwi_old">IFWI</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="UEFI Profile/Other" id="fw_uefi" checked>
                                                <label class="form-check-label small" for="fw_uefi">UEFI Profile/Other</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="BMC FW" id="fw_bmc" checked>
                                                <label class="form-check-label small" for="fw_bmc">BMC FW</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="Inventory" id="fw_inventory" checked>
                                                <label class="form-check-label small" for="fw_inventory">Inventory</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="PowerCapping" id="fw_powercapping" checked>
                                                <label class="form-check-label small" for="fw_powercapping">PowerCapping</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="FanTable" id="fw_fantable" checked>
                                                <label class="form-check-label small" for="fw_fantable">FanTable</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="SDRGenerator" id="fw_sdr" checked>
                                                <label class="form-check-label small" for="fw_sdr">SDRGenerator</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="IPMIAllowList" id="fw_ipmi" checked>
                                                <label class="form-check-label small" for="fw_ipmi">IPMIAllowList</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="BMC Tip" id="fw_bmc_tip" checked>
                                                <label class="form-check-label small" for="fw_bmc_tip">BMC Tip</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="BMC TIP PCD Platform ID" id="fw_bmc_tip_platform" checked>
                                                <label class="form-check-label small" for="fw_bmc_tip_platform">BMC TIP PCD Platform ID</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="BMC TIP PCD Version ID (hex)/(dec)" id="fw_bmc_tip_version" checked>
                                                <label class="form-check-label small" for="fw_bmc_tip_version">BMC TIP PCD Version ID</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="Manticore (HSM)" id="fw_manticore" checked>
                                                <label class="form-check-label small" for="fw_manticore">Manticore (HSM)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="CFM Platform ID" id="fw_cfm_platform" checked>
                                                <label class="form-check-label small" for="fw_cfm_platform">CFM Platform ID</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="CFM Version ID (hex)/(dec)" id="fw_cfm_version" checked>
                                                <label class="form-check-label small" for="fw_cfm_version">CFM Version ID</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="TPM Module" id="fw_tpm" checked>
                                                <label class="form-check-label small" for="fw_tpm">TPM Module</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category dc_scm" type="checkbox" value="SCM-CPLD" id="fw_scm_cpld" checked>
                                                <label class="form-check-label small" for="fw_scm_cpld">SCM-CPLD</label>
                                            </div>
                                        </div>
                                        
                                        <!-- OVL2 -->
                                        <div class="col-md-4">
                                            <h6 class="text-success">OVL2 (12 types)</h6>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="FPGA Agilex (App Image w/ OpRom)" id="fw_agilex" checked>
                                                <label class="form-check-label small" for="fw_agilex">FPGA Agilex (App Image w/ OpRom)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="Cyclone V Image" id="fw_cyclone" checked>
                                                <label class="form-check-label small" for="fw_cyclone">Cyclone V Image</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="Cyclone V PFMID" id="fw_cyclone_pfmid" checked>
                                                <label class="form-check-label small" for="fw_cyclone_pfmid">Cyclone V PFMID</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="OVL SOC FIP" id="fw_soc_fip" checked>
                                                <label class="form-check-label small" for="fw_soc_fip">OVL SOC FIP</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="OVL SOC FIP PFMID" id="fw_soc_fip_pfmid" checked>
                                                <label class="form-check-label small" for="fw_soc_fip_pfmid">OVL SOC FIP PFMID</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="SOC Test OS (STOS)" id="fw_stos" checked>
                                                <label class="form-check-label small" for="fw_stos">SOC Test OS (STOS)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="Host FPGA Driver & Tools" id="fw_host_fpga" checked>
                                                <label class="form-check-label small" for="fw_host_fpga">Host FPGA Driver & Tools</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="SOC FPGA Driver" id="fw_soc_fpga" checked>
                                                <label class="form-check-label small" for="fw_soc_fpga">SOC FPGA Driver</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="MANA Driver (Windows)" id="fw_mana" checked>
                                                <label class="form-check-label small" for="fw_mana">MANA Driver (Windows)</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="Glacier Cerberus FW" id="fw_cerberus" checked>
                                                <label class="form-check-label small" for="fw_cerberus">Glacier Cerberus FW</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="Glacier Cerberus Utility" id="fw_cerberus_util" checked>
                                                <label class="form-check-label small" for="fw_cerberus_util">Glacier Cerberus Utility</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category ovl2" type="checkbox" value="Glacier Peak CFM" id="fw_cfm" checked>
                                                <label class="form-check-label small" for="fw_cfm">Glacier Peak CFM</label>
                                            </div>
                                        </div>
                                        
                                        <!-- Other Platform -->
                                        <div class="col-md-4">
                                            <h6 class="text-warning">Other Platform (5 types)</h6>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category other_platform" type="checkbox" value="HPMCpld" id="fw_hpm_cpld" checked>
                                                <label class="form-check-label small" for="fw_hpm_cpld">HPMCpld</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category other_platform" type="checkbox" value="SOC VR Configs" id="fw_soc_vr" checked>
                                                <label class="form-check-label small" for="fw_soc_vr">SOC VR Configs</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category other_platform" type="checkbox" value="E.1s" id="fw_e1s" checked>
                                                <label class="form-check-label small" for="fw_e1s">E.1s</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category other_platform" type="checkbox" value="M.2" id="fw_m2" checked>
                                                <label class="form-check-label small" for="fw_m2">M.2</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category other_platform" type="checkbox" value="Windows OS Version" id="fw_os_version" checked>
                                                <label class="form-check-label small" for="fw_os_version">Windows OS Version</label>
                                            </div>
                                            <div class="form-check">
                                                <input class="form-check-input fw-category other_platform" type="checkbox" value="DIMM Information" id="fw_dimm_info" checked>
                                                <label class="form-check-label small" for="fw_dimm_info">DIMM Information</label>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="mt-3">
                                        <p class="text-muted small mb-0">
                                            <i class="bi bi-info-circle"></i> <span id="selectedCount">34 firmware types</span> will be checked
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Recipe Selection -->
                <div class="row mb-4">
                    <div class="col-12">
                        <div class="card border-success">
                            <div class="card-body">
                                <h6><i class="bi bi-file-earmark-check"></i> Firmware Recipe Validation <span class="badge bg-success">Optional</span></h6>
                                <p class="text-muted small">Select a firmware recipe to validate the detected versions against expected configurations</p>
                                <div class="row">
                                    <div class="col-md-8">
                                        <select class="form-select" id="recipe_id" name="recipe_id">
                                            <option value="">No recipe - Just check versions</option>
                                            {% if recipes %}
                                                {% for recipe in recipes %}
                                                <option value="{{ recipe.id }}">{{ recipe.name }}</option>
                                                {% endfor %}
                                            {% endif %}
                                        </select>
                                    </div>
                                    <div class="col-md-4">
                                        <a href="{{ url_for('recipes') }}" class="btn btn-outline-primary w-100" target="_blank">
                                            <i class="bi bi-box-arrow-up-right"></i> Manage Recipes
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="text-center">
                    <button id="startCheckBtn" class="btn btn-success btn-lg" 
                            data-system-id="{{ system.id }}" onclick="startFirmwareCheck()">
                        <i class="bi bi-play-circle"></i> Start Firmware Check
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Progress Section (shown when form submission occurs on non-active check page) -->
<div id="progressSection" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-clock"></i> Check Progress</h5>
            </div>
            <div class="card-body">
                <div class="progress mb-3">
                    <div id="progressBar" class="progress-bar progress-bar-striped progress-bar-animated" 
                         role="progressbar" style="width: 0%"></div>
                </div>
                <div id="progressStatus" class="text-center text-muted">
                    Initializing firmware check...
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Results Section -->
<div id="resultsSection" class="row mt-4" style="display: none;">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-clipboard-data"></i> Firmware Check Results</h5>
                <button id="exportBtn" class="btn btn-outline-primary btn-sm" onclick="exportResults()">
                    <i class="bi bi-download"></i> Export Results
                </button>
            </div>
            <div class="card-body">
                <div id="resultsContent">
                    <!-- Results will be populated here -->
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// Get the script root for URL generation (handles /firmware-checker prefix)
const SCRIPT_ROOT = {{ request.script_root|tojson }};

let checkResults = null;

// Firmware Selection Functions
function updateSelectedCount() {
    // Only count visible checkboxes (exclude d-none hidden section)
    const checkboxes = document.querySelectorAll('.fw-category:checked:not(.d-none .fw-category)');
    const visibleChecked = Array.from(checkboxes).filter(cb => {
        return !cb.closest('.d-none');
    });
    const count = visibleChecked.length;
    document.getElementById('selectedCount').textContent = `${count} firmware type${count !== 1 ? 's' : ''}`;
}

function selectAllFirmware() {
    // Only select visible checkboxes
    document.querySelectorAll('.fw-category').forEach(cb => {
        if (!cb.closest('.d-none')) {
            cb.checked = true;
        }
    });
    updateSelectedCount();
}

function deselectAllFirmware() {
    // Only deselect visible checkboxes
    document.querySelectorAll('.fw-category').forEach(cb => {
        if (!cb.closest('.d-none')) {
            cb.checked = false;
        }
    });
    updateSelectedCount();
}

function selectCategory(category) {
    // Deselect all visible checkboxes first
    document.querySelectorAll('.fw-category').forEach(cb => {
        if (!cb.closest('.d-none')) {
            cb.checked = false;
        }
    });
    // Select only the specified category (visible only)
    document.querySelectorAll(`.fw-category.${category}`).forEach(cb => {
        if (!cb.closest('.d-none')) {
            cb.checked = true;
        }
    });
    updateSelectedCount();
}

function getSelectedFirmwareTypes() {
    const selected = {
        dc_scm: [],
        ovl2: [],
        other_platform: []
    };
    
    // Only get visible checked checkboxes
    document.querySelectorAll('.fw-category:checked').forEach(cb => {
        if (!cb.closest('.d-none')) {
            const category = Array.from(cb.classList).find(c => ['dc_scm', 'ovl2', 'other_platform'].includes(c));
            if (category) {
                selected[category].push(cb.value);
            }
        }
    });
    
    return selected;
}

// Add event listeners to update count when checkboxes change
document.addEventListener('DOMContentLoaded', function() {
    // Update selected count on checkbox changes
    document.querySelectorAll('.fw-category').forEach(cb => {
        cb.addEventListener('change', updateSelectedCount);
    });
    
    // Auto-start monitoring if there's an active check
    {% if active_check %}
    startActiveCheckMonitoring({{ system.id }});
    {% endif %}
});

// Active Check Monitoring Functions
let activeCheckInterval = null;

function startActiveCheckMonitoring(systemId) {
    console.log('Starting active check monitoring for system', systemId);
    refreshActiveStatus(systemId);
    // Poll every 10 seconds
    activeCheckInterval = setInterval(() => refreshActiveStatus(systemId), 10000);
}

function stopActiveCheckMonitoring() {
    if (activeCheckInterval) {
        clearInterval(activeCheckInterval);
        activeCheckInterval = null;
    }
}

function refreshActiveStatus(systemId) {
    // If systemId not provided, try to get it from the page
    if (!systemId) {
        const startBtn = document.getElementById('startCheckBtn');
        if (startBtn) {
            systemId = parseInt(startBtn.getAttribute('data-system-id'));
        }
    }
    
    if (!systemId) {
        console.error('[Active Monitor] Cannot refresh: systemId not available');
        return;
    }
    
    console.log('[Active Monitor] Checking status for system:', systemId);
    fetch(SCRIPT_ROOT + `/api/check-status/${systemId}`)
        .then(response => {
            console.log('[Active Monitor] Response status:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('[Active Monitor] Data received:', data);
            
            if (data.status === 'completed') {
                // Check is complete, redirect to results page
                console.log('[Active Monitor] CHECK COMPLETED! Stopping monitoring...');
                stopActiveCheckMonitoring();
                
                if (data.check_id) {
                    const redirectUrl = `${SCRIPT_ROOT}/check/result/${data.check_id}`;
                    console.log('[Active Monitor] Redirecting to:', redirectUrl);
                    
                    // Update UI before redirect
                    const progressBar = document.getElementById('activeProgressBar');
                    const progressText = document.getElementById('activeProgressText');
                    if (progressBar) {
                        progressBar.style.width = '100%';
                        progressBar.classList.remove('bg-info', 'progress-bar-animated');
                        progressBar.classList.add('bg-success');
                    }
                    if (progressText) {
                        progressText.textContent = 'Complete! Redirecting...';
                    }
                    
                    // Redirect immediately
                    window.location.href = redirectUrl;
                } else {
                    // Fallback: reload page if check_id not available
                    console.warn('[Active Monitor] Check completed but no check_id available, reloading page');
                    window.location.reload();
                }
            } else if (data.status === 'error') {
                // Check failed
                stopActiveCheckMonitoring();
                updateActiveProgress({
                    progress: {
                        percentage: 100,
                        current_category: 'Error',
                        current_firmware: data.error || 'Check failed',
                        completed: 0,
                        total: 0
                    }
                });
                const progressBar = document.getElementById('activeProgressBar');
                if (progressBar) {
                    progressBar.classList.remove('bg-info', 'progress-bar-animated');
                    progressBar.classList.add('bg-danger');
                }
            } else if (data.status === 'running' && data.progress_data) {
                // Update progress bar with real data
                updateActiveProgress(data.progress_data);
            } else if (data.status === 'none') {
                // No check found - page may be stale
                console.log('[Active Monitor] No check found, stopping monitoring');
                stopActiveCheckMonitoring();
                alert('No active check found. The page may be outdated.');
                window.location.reload();
            }
        })
        .catch(error => {
            console.error('Error checking active status:', error);
            alert('Failed to check status: ' + error.message);
        });
}

function updateActiveProgress(progressData) {
    const progressBar = document.getElementById('activeProgressBar');
    const progressText = document.getElementById('activeProgressText');
    
    if (progressBar && progressText && progressData && progressData.progress) {
        const progress = progressData.progress;
        const percentage = progress.percentage || 5;
        const currentCat = progress.current_category || 'Unknown';
        const currentFw = progress.current_firmware || 'Starting...';
        const completed = progress.completed || 0;
        const total = progress.total || 0;
        
        // Update progress bar
        progressBar.style.width = percentage + '%';
        
        // Update progress text
        progressText.textContent = `${currentCat}: ${currentFw} (${completed}/${total} complete)`;
        
        console.log(`Active progress update: ${percentage}% - ${currentFw}`);
    }
}

// Clean up interval when leaving the page
window.addEventListener('beforeunload', function() {
    stopActiveCheckMonitoring();
});

function startFirmwareCheck() {
    const startBtn = document.getElementById('startCheckBtn');
    const progressSection = document.getElementById('progressSection');
    const progressBar = document.getElementById('progressBar');
    const progressStatus = document.getElementById('progressStatus');
    
    // Get system ID from data attribute
    const systemId = parseInt(startBtn.getAttribute('data-system-id'));
    
    // Get credentials from form
    const username = document.getElementById('username').value.trim();
    const password = document.getElementById('password').value.trim();
    const osUsername = document.getElementById('os_username').value.trim();
    const osPassword = document.getElementById('os_password').value.trim();
    const computerName = document.getElementById('computer_name').value.trim();
    const recipeId = document.getElementById('recipe_id').value;
    
    // Validate credentials
    if (!username || !password) {
        alert('Username and password are required!');
        return;
    }
    
    // Validate OS credentials - if any OS credential is provided, all are required
    if ((osUsername || osPassword || computerName) && (!osUsername || !osPassword || !computerName)) {
        alert('For storage firmware checks, all three fields are required: OS Username, OS Password, and Target Computer/IP');
        return;
    }
    
    // Disable start button and show progress
    startBtn.disabled = true;
    startBtn.innerHTML = '<i class="bi bi-clock"></i> Checking...';
    progressSection.style.display = 'block';
    
    // Start with basic progress indication
    progressBar.style.width = '10%';
    progressStatus.textContent = 'Initializing firmware check...';
    
    // Start realistic progress simulation
    let progressValue = 10;
    const progressSteps = [
        { msg: 'Connecting to system...', progress: 15, delay: 3000 },
        { msg: 'Checking DC-SCM firmware (16 types)...', progress: 35, delay: 8000 },
        { msg: 'Checking OVL2 firmware via SSH sessions (16 types)...', progress: 75, delay: 25000 },
        { msg: 'Checking Other Platform firmware (6 types)...', progress: 90, delay: 5000 },
        { msg: 'Processing results...', progress: 95, delay: 2000 }
    ];
    
    let stepIndex = 0;
    let progressInterval;
    
    function updateRealisticProgress() {
        if (stepIndex < progressSteps.length) {
            const step = progressSteps[stepIndex];
            progressBar.style.width = step.progress + '%';
            progressStatus.textContent = step.msg;
            stepIndex++;
            
            progressInterval = setTimeout(updateRealisticProgress, step.delay);
        }
    }
    
    updateRealisticProgress();
    
    // Get selected firmware types
    const selectedFirmware = getSelectedFirmwareTypes();
    console.log('Selected firmware types:', selectedFirmware);
    
    // Make API call
    fetch(SCRIPT_ROOT + '/api/check-firmware', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            system_id: systemId,
            username: username,
            password: password,
            os_username: osUsername || null,
            os_password: osPassword || null,
            computer_name: computerName || null,
            recipe_id: recipeId || null,
            selected_firmware: selectedFirmware
        })
    })
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        return response.json();
    })
    .then(data => {
        // Clear any remaining progress timeouts
        clearTimeout(progressInterval);
        
        // Check if this is the new threaded response (HTTP 202)
        if (data.status === 'started' && data.check_id) {
            // Redirect back to this same page, which will now show the active check progress
            window.location.href = SCRIPT_ROOT + `/check/${systemId}`;
        } else {
            // Old synchronous response (shouldn't happen anymore, but fallback)
            completeCheck(data, startBtn, progressBar, progressStatus, systemId);
        }
    })
    .catch(error => {
        clearTimeout(progressInterval);
        
        // Show error
        progressBar.classList.remove('progress-bar-animated');
        progressBar.classList.add('bg-danger');
        progressStatus.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Firmware check failed: ' + error.message;
        
        // Reset button
        startBtn.disabled = false;
        startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Retry Check';
        
        console.error('Error:', error);
    });
}

function monitorThreadedCheck(checkId, systemId, startBtn, progressBar, progressStatus) {
    // Store check_id globally so completeCheck can access it for redirect
    window.currentCheckId = checkId;
    
    let pollCount = 0;
    const maxPolls = 300; // 10 minutes max polling (2-second intervals)
    
    function pollProgress() {
        pollCount++;
        
        // Poll the check status
        fetch(`/api/check-status/${systemId}`)
        .then(response => response.json())
        .then(statusData => {
            console.log('Status update:', statusData);
            
            if (statusData.status === 'running') {
                // Update progress based on actual firmware check progress
                let progressPercent = 5; // Base progress
                let statusMessage = 'Firmware check in progress...';
                
                // Debug logging
                console.log('Progress data:', statusData.progress_data);
                
                // Check if we have progress data from firmware_data
                if (statusData.progress_data && statusData.progress_data.progress) {
                    const progress = statusData.progress_data.progress;
                    progressPercent = progress.percentage || 5;
                    
                    const currentFw = progress.current_firmware || 'Unknown';
                    const currentCat = progress.current_category || 'Unknown';
                    const completed = progress.completed || 0;
                    const total = progress.total || 0;
                    
                    statusMessage = `Checking ${currentCat}: ${currentFw} (${completed}/${total} complete)`;
                    console.log(`Progress: ${progressPercent}% - ${statusMessage}`);
                } else if (statusData.thread_info) {
                    // Fallback to runtime-based estimation if no progress data yet
                    const runtime = statusData.thread_info.runtime_minutes || 0;
                    const category = statusData.thread_info.current_category || 'unknown';
                    
                    progressPercent = Math.min(10 + (runtime * 5), 95);
                    statusMessage = `Checking ${category} firmware... (${runtime.toFixed(1)} min)`;
                }
                
                progressBar.style.width = progressPercent + '%';
                progressStatus.textContent = statusMessage;
                
                // Continue polling
                if (pollCount < maxPolls) {
                    setTimeout(pollProgress, 2000); // Poll every 2 seconds
                } else {
                    // Timeout - show warning but keep checking
                    progressStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Check is taking longer than expected... <a href="' + SCRIPT_ROOT + '/check/result/' + checkId + '" class="btn btn-sm btn-outline-primary ms-2">View Progress Page</a>';
                }
                
            } else if (statusData.status === 'completed') {
                // Check completed successfully
                fetchCompletedResults(checkId, startBtn, progressBar, progressStatus, systemId);
                
            } else if (statusData.status === 'error') {
                // Check failed
                progressBar.classList.remove('progress-bar-animated');
                progressBar.classList.add('bg-danger');
                progressStatus.innerHTML = '<i class="bi bi-x-circle text-danger"></i> Firmware check failed: ' + (statusData.error || 'Unknown error');
                
                startBtn.disabled = false;
                startBtn.innerHTML = '<i class="bi bi-play-circle"></i> Retry Check';
                
            } else {
                // Unknown status
                progressStatus.textContent = 'Check status: ' + statusData.status;
                if (pollCount < maxPolls) {
                    setTimeout(pollProgress, 2000);
                }
            }
        })
        .catch(error => {
            console.error('Error polling progress:', error);
            if (pollCount < maxPolls) {
                setTimeout(pollProgress, 5000); // Retry with longer delay
            } else {
                progressStatus.innerHTML = '<i class="bi bi-exclamation-triangle text-warning"></i> Lost connection to server. <a href="' + SCRIPT_ROOT + '/check/result/' + checkId + '" class="btn btn-sm btn-outline-primary ms-2">Check Results</a>';
            }
        });
    }
    
    // Start polling
    setTimeout(pollProgress, 2000); // Initial delay before first poll
}

function fetchCompletedResults(checkId, startBtn, progressBar, progressStatus, systemId) {
    // Store check_id globally for redirect
    window.currentCheckId = checkId;
    
    // Redirect immediately to results page
    progressBar.style.width = '100%';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-success');
    progressStatus.innerHTML = `<i class="bi bi-check-circle text-success"></i> Firmware check completed! Redirecting to results...`;
    
    setTimeout(() => {
        window.location.href = `${SCRIPT_ROOT}/check/result/${checkId}`;
    }, 1500);
}

function completeCheck(data, startBtn, progressBar, progressStatus, systemId) {
    // Complete progress
    progressBar.style.width = '100%';
    progressBar.classList.remove('progress-bar-animated');
    progressBar.classList.add('bg-success');
    progressStatus.innerHTML = '<i class="bi bi-check-circle text-success"></i> Firmware check completed! Redirecting to results...';
    
    // Get the check_id from the current context
    // The check_id should be available from the pollProgress function context
    const checkId = window.currentCheckId;
    
    // Redirect to results page after a brief delay
    setTimeout(() => {
        window.location.href = `${SCRIPT_ROOT}/check/result/${checkId}`;
    }, 1500);
}

function displayResults(data) {
    const resultsSection = document.getElementById('resultsSection');
    const resultsContent = document.getElementById('resultsContent');
    
    // Validate that we have the expected data structure
    if (!data || !data.dc_scm || !data.ovl2 || !data.other_platform) {
        console.error('Invalid data structure for results:', data);
        return;
    }
    
    // Safe access to firmware_versions with fallbacks
    const dcScmCount = data.dc_scm.firmware_versions ? Object.keys(data.dc_scm.firmware_versions).length : 0;
    const otherPlatformCount = data.other_platform.firmware_versions ? Object.keys(data.other_platform.firmware_versions).length : 0;
    const ovl2Count = data.ovl2.firmware_versions ? Object.keys(data.ovl2.firmware_versions).length : 0;
    
    let html = `
        <div class="row mb-3">
            <div class="col-md-6">
                <h6>Check Summary</h6>
                <ul class="list-unstyled">
                    <li><strong>System:</strong> ${data.system_name || 'Unknown'}</li>
                    <li><strong>RSCM IP:</strong> <code>${data.rscm_ip || 'Unknown'}:${data.rscm_port || 'Unknown'}</code></li>
                    <li><strong>Check Date:</strong> ${data.check_date ? new Date(data.check_date).toLocaleString() : 'Unknown'}</li>
                </ul>
            </div>
            <div class="col-md-6">
                <h6>Categories Checked</h6>
                <ul class="list-unstyled">
                    <li><i class="bi bi-check-circle text-success"></i> DC-SCM: ${dcScmCount} types</li>
                    <li><i class="bi bi-check-circle text-success"></i> Other Platform: ${otherPlatformCount} types</li>
                    <li><i class="bi bi-check-circle text-success"></i> OVL2: ${ovl2Count} types</li>
                </ul>
            </div>
        </div>
    `;
    
    // Create tabs for each category
    html += `
        <ul class="nav nav-tabs" id="categoryTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="dc-scm-tab" data-bs-toggle="tab" data-bs-target="#dc-scm" 
                        type="button" role="tab">DC-SCM</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="other-platform-tab" data-bs-toggle="tab" data-bs-target="#other-platform" 
                        type="button" role="tab">Other Platform</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="ovl2-tab" data-bs-toggle="tab" data-bs-target="#ovl2" 
                        type="button" role="tab">OVL2</button>
            </li>
        </ul>
        
        <div class="tab-content" id="categoryTabContent">
            <div class="tab-pane fade show active" id="dc-scm" role="tabpanel">
                ${createCategoryTable(data.dc_scm)}
            </div>
            <div class="tab-pane fade" id="other-platform" role="tabpanel">
                ${createCategoryTable(data.other_platform)}
            </div>
            <div class="tab-pane fade" id="ovl2" role="tabpanel">
                ${createCategoryTable(data.ovl2)}
            </div>
        </div>
    `;
    
    resultsContent.innerHTML = html;
    resultsSection.style.display = 'block';
}

function createCategoryTable(categoryData) {
    if (!categoryData || !categoryData.firmware_versions) {
        return `<div class="mt-3"><p class="text-muted">No firmware data available for this category.</p></div>`;
    }
    
    let html = `
        <div class="mt-3">
            <h6>${categoryData.category || 'Unknown Category'} Firmware Versions</h6>
            <div class="table-responsive">
                <table class="table table-sm table-hover">
                    <thead>
                        <tr>
                            <th>Firmware Type</th>
                            <th>Version</th>
                            <th>Status</th>
                            <th>Checked At</th>
                        </tr>
                    </thead>
                    <tbody>
    `;
    
    for (const [fwType, fwData] of Object.entries(categoryData.firmware_versions || {})) {
        let statusBadge;
        switch(fwData.status) {
            case 'success':
                statusBadge = '<span class="badge bg-success">Success</span>';
                break;
            case 'not_implemented':
                statusBadge = '<span class="badge bg-warning">Not Implemented</span>';
                break;
            case 'error':
                statusBadge = '<span class="badge bg-danger">Error</span>';
                break;
            case 'not_found':
                statusBadge = '<span class="badge bg-info">Not Found</span>';
                break;
            default:
                statusBadge = `<span class="badge bg-light text-dark">Unknown (${fwData.status})</span>`;
        }
            
        const version = fwData.version || 'N/A';
        const checkedAt = fwData.checked_at ? new Date(fwData.checked_at).toLocaleString() : 'Unknown';
        
        html += `
            <tr>
                <td><strong>${fwType}</strong></td>
                <td><code>${version}</code></td>
                <td>${statusBadge}</td>
                <td><small class="text-muted">${checkedAt}</small></td>
            </tr>
        `;
    }
    
    html += `
                    </tbody>
                </table>
            </div>
        </div>
    `;
    
    return html;
}

function exportResults() {
    if (!checkResults) return;
    
    const dataStr = JSON.stringify(checkResults, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `firmware-check-${checkResults.system_name}-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
}
</script>
{% endblock %}